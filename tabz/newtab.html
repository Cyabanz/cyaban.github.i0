<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>New Tab</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <style>
    * { box-sizing: border-box; }
    body {
      background: var(--bg, #202124);
      color: var(--fg, #e8eaed);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      transition: all 0.3s ease;
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at 20% 50%, rgba(66, 165, 245, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(156, 39, 176, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 40% 80%, rgba(76, 175, 80, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    .search-bar {
      margin-top: 120px;
      width: 100%;
      max-width: 600px;
      display: flex;
      border-radius: 50px;
      overflow: hidden;
      background: rgba(48, 49, 52, 0.8);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
    }
    .search-bar:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), 
                  inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    .search-bar:focus-within {
      border-color: rgba(26, 115, 232, 0.6);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), 
                  0 0 0 2px rgba(26, 115, 232, 0.3),
                  inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    .search-bar input {
      flex: 1;
      padding: 18px 24px;
      border: none;
      background: transparent;
      color: var(--fg, #e8eaed);
      font-size: 16px;
      outline: none;
      font-family: inherit;
      font-weight: 400;
    }
    .search-bar input::placeholder {
      color: rgba(232, 234, 237, 0.6);
      font-weight: 300;
    }
    .search-bar button {
      background: rgba(26, 115, 232, 0.8);
      color: #ffffff;
      border: none;
      padding: 18px 24px;
      cursor: pointer;
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
      font-weight: 500;
      min-width: 60px;
    }
    .search-bar button:hover {
      background: rgba(26, 115, 232, 1);
      transform: scale(1.05);
    }
    .bookmarks {
      margin-top: 60px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 24px;
      width: 100%;
      max-width: 1000px;
      padding: 0 32px;
      z-index: 1;
      position: relative;
    }
    .bookmark {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(40, 41, 44, 0.8);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 24px 16px 20px;
      text-decoration: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }
    .bookmark::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .bookmark:hover {
      transform: translateY(-8px) scale(1.02);
      background: rgba(53, 54, 58, 0.9);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3),
                  0 0 20px rgba(26, 115, 232, 0.2);
    }
    .bookmark:hover::before { opacity: 1; }
    .bookmark-icon-img {
      width: 56px;
      height: 56px;
      margin-bottom: 16px;
      border-radius: 16px;
      object-fit: cover;
      background: rgba(255, 255, 255, 0.1);
      display: block;
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    .bookmark:hover .bookmark-icon-img {
      transform: scale(1.1);
      border-color: rgba(26, 115, 232, 0.5);
    }
    .bookmark-label {
      text-align: center;
      font-size: 14px;
      color: var(--fg, #e8eaed);
      font-weight: 500;
      word-break: break-word;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 18px;
      letter-spacing: 0.3px;
    }
    .delete-bookmark-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(220, 53, 69, 0.9);
      color: #ffffff;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      opacity: 0;
      z-index: 2;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    .delete-bookmark-btn:hover {
      background: rgba(220, 53, 69, 1);
      transform: scale(1.1);
    }
    .bookmark:hover .delete-bookmark-btn {
      opacity: 1;
    }
    .add-bookmark-bar {
      margin-top: 40px;
      width: 100%;
      max-width: 800px;
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: rgba(40, 41, 44, 0.8);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      flex-wrap: wrap;
      z-index: 1;
      position: relative;
    }
    .add-bookmark-bar input {
      background: rgba(48, 49, 52, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--fg, #e8eaed);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 14px;
      min-width: 200px;
      outline: none;
      transition: all 0.3s ease;
      font-family: inherit;
      backdrop-filter: blur(10px);
    }
    .add-bookmark-bar input:focus {
      border-color: rgba(26, 115, 232, 0.6);
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
      background: rgba(48, 49, 52, 0.8);
    }
    .add-bookmark-bar input::placeholder {
      color: rgba(232, 234, 237, 0.6);
    }
    .add-bookmark-bar button {
      background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
      color: #ffffff;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
    }
    .add-bookmark-bar button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(26, 115, 232, 0.4);
    }
    .add-bookmark-bar button[style*="background:#444"] {
      background: linear-gradient(135deg, #5f6368 0%, #3c4043 100%) !important;
      box-shadow: 0 4px 15px rgba(95, 99, 104, 0.3);
    }
    .add-bookmark-bar button[style*="background:#444"]:hover {
      box-shadow: 0 8px 25px rgba(95, 99, 104, 0.4);
    }
    .show { display: flex !important; }
    .hidden { display: none !important; }
    .make-bookmark-btn {
      margin: 40px 0 0 0;
      padding: 16px;
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
      color: #ffffff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
      box-shadow: 0 8px 30px rgba(26, 115, 232, 0.4);
      position: relative;
      overflow: hidden;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .make-bookmark-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    .make-bookmark-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 15px 40px rgba(26, 115, 232, 0.5);
    }
    .make-bookmark-btn:hover::before {
      left: 100%;
    }
    @media (max-width: 768px) {
      .search-bar {
        margin-top: 80px;
        max-width: calc(100vw - 32px);
        margin-left: 16px;
        margin-right: 16px;
      }
      .bookmarks {
        max-width: calc(100vw - 32px);
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 16px;
        margin-top: 40px;
        padding: 0 16px;
      }
      .add-bookmark-bar {
        max-width: calc(100vw - 32px);
        margin-left: 16px;
        margin-right: 16px;
        flex-direction: column;
        gap: 12px;
      }
      .add-bookmark-bar input {
        width: 100%;
        max-width: 300px;
        min-width: auto;
      }
      .bookmark {
        padding: 20px 12px 16px;
      }
      .bookmark-icon-img {
        width: 48px;
        height: 48px;
      }
      .make-bookmark-btn {
        width: 56px;
        height: 56px;
        font-size: 20px;
      }
    }
    @media (max-width: 480px) {
      .bookmarks {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      .bookmark-icon-img {
        width: 44px;
        height: 44px;
      }
      .bookmark-label {
        font-size: 12px;
        max-width: 80px;
      }
      .search-bar input {
        padding: 16px 20px;
        font-size: 15px;
      }
      .search-bar button {
        padding: 16px 20px;
      }
      .make-bookmark-btn {
        width: 52px;
        height: 52px;
        font-size: 18px;
      }
    }
  </style>
  <script src="/uv/uv.bundle.js"></script>
  <script src="/uv/uv.config.js"></script>
</head>
<body>
  <form class="search-bar" id="nt-search-form" autocomplete="off">
    <input id="nt-search" type="text" placeholder="Search or type a URL" autofocus>
    <button type="submit">→</button>
  </form>
  <button class="make-bookmark-btn" id="show-add-bookmark" title="Add Bookmark">
    <i class='bx bx-plus'></i>
  </button>
  <form class="add-bookmark-bar hidden" id="add-bookmark-bar">
    <input type="text" id="bm-url" placeholder="Bookmark URL (https://)">
    <input type="text" id="bm-label" placeholder="Label (e.g. Twitter)">
    <input type="text" id="bm-img" placeholder="Image URL (icon)">
    <button id="bm-add">Add</button>
    <button id="bm-cancel" type="button" style="background:#444;">Cancel</button>
  </form>
  <div class="bookmarks" id="nt-bookmarks"></div>
  <script>
    // --- THEME SYNC ---
    // Listen for theme updates from parent
    function applyThemeVars(style) {
      document.body.style.setProperty('--bg', style.bg || "#202124");
      document.body.style.setProperty('--fg', style.fg || "#e8eaed");
      document.body.style.setProperty('--section-bg', style.section_bg || "#23242b");
      document.body.style.background = style.bg || "#202124";
      document.body.style.color = style.fg || "#e8eaed";
    }
    function getThemeStyle() {
      let theme = localStorage.getItem('theme') || 'dark';
      let customTheme = {};
      try { customTheme = JSON.parse(localStorage.getItem('customTheme') || '{}'); } catch(e){}
      let vars = {
        dark:   { bg: "#202124", fg: "#e8eaed", section_bg: "#23242b" },
        light:  { bg: "#f4f5fa", fg: "#181818", section_bg: "#ffffff" },
        purple: { bg: "#2a183b", fg: "#f9d7ff", section_bg: "#391a53" }
      };
      let style = vars[theme] || vars.dark;
      if (theme === 'custom' && customTheme.bg && customTheme.fg && customTheme.section_bg) {
        style = customTheme;
      }
      return style;
    }
    function applyThemeFromParentOrStorage() {
      if (window.parent !== window) {
        // Ask parent for theme
        window.parent.postMessage({ ntThemeRequest: true }, '*');
      } else {
        // Standalone: use localStorage
        applyThemeVars(getThemeStyle());
      }
    }
    // Handle parent theme response
    window.addEventListener('message', e => {
      if (e.data && e.data.ntSetTheme && typeof e.data.ntSetTheme === "object") {
        // e.data.ntSetTheme should be an object with .bg, .fg, .section_bg
        applyThemeVars(e.data.ntSetTheme);
      }
      // --- Keep UV open-in-tab working ---
      if (e.data.ntNavigate) openUvUrl(e.data.ntNavigate);
    });
    // Also react to localStorage theme changes (if open as standalone)
    window.addEventListener('storage', function(e) {
      if (['theme', 'customTheme'].includes(e.key)) {
        applyThemeFromParentOrStorage();
      }
    });
    // Initial theme application
    applyThemeFromParentOrStorage();

    // --- Default bookmarks ---
    const defaultBookmarks = [
      { url: "https://www.google.com", label: "Google", img: "https://www.google.com/favicon.ico" },
      { url: "https://www.youtube.com", label: "YouTube", img: "https://www.youtube.com/s/desktop/2e7e9e8e/img/favicon_48x48.png" },
      { url: "https://github.com", label: "GitHub", img: "https://github.githubassets.com/favicons/favicon.png" },
      { url: "https://mail.google.com", label: "Gmail", img: "https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico" },
      { url: "https://chat.openai.com", label: "ChatGPT", img: "https://chat.openai.com/favicon.ico" }
    ];

    const USER_BM_KEY = "uv_user_bookmarks_v1";
    const bmEl = document.getElementById('nt-bookmarks');

    function getUserBookmarks() {
      try {
        const arr = JSON.parse(localStorage.getItem(USER_BM_KEY));
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }
    function setUserBookmarks(arr) {
      localStorage.setItem(USER_BM_KEY, JSON.stringify(arr));
    }
    function allBookmarks() {
      // Merge default and user bookmarks (user bookmarks after default)
      return [...defaultBookmarks, ...getUserBookmarks()];
    }
    function renderBookmarks() {
      bmEl.innerHTML = "";
      const bookmarks = allBookmarks();
      bookmarks.forEach((bm, idx) => {
        const a = document.createElement('a');
        a.className = 'bookmark';
        a.href = "#";
        a.innerHTML =
          `<img class="bookmark-icon-img" src="${bm.img ? bm.img : 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f517.png'}" alt="icon">
           <div class="bookmark-label">${bm.label || bm.url}</div>`;
        a.addEventListener('click', e => {
          e.preventDefault();
          // --- Save to search history ---
          if (window.parent !== window) {
            window.parent.postMessage({ addSearchHistory: { query: bm.url } }, "*");
          } else {
            let arr = JSON.parse(localStorage.getItem('uv_search_history') || "[]");
            arr.push({query: bm.url, time: (new Date()).toISOString()});
            localStorage.setItem('uv_search_history', JSON.stringify(arr));
          }
          openUvUrl(bm.url);
        });
        // Allow deleting user bookmarks (but not default)
        if (idx >= defaultBookmarks.length) {
          const btn = document.createElement("button");
          btn.className = "delete-bookmark-btn";
          btn.innerHTML = "✕";
          btn.title = "Delete";
          btn.onclick = (ev) => {
            ev.preventDefault();
            ev.stopPropagation();
            const userBms = getUserBookmarks();
            userBms.splice(idx - defaultBookmarks.length, 1);
            setUserBookmarks(userBms);
            renderBookmarks();
          };
          a.appendChild(btn);
        }
        bmEl.appendChild(a);
      });
    }

    // --- Add bookmark UI logic ---
    const showAddBtn = document.getElementById("show-add-bookmark");
    const addBar = document.getElementById("add-bookmark-bar");
    showAddBtn.onclick = () => {
      addBar.classList.remove('hidden');
      showAddBtn.classList.add('hidden');
      document.getElementById("bm-url").focus();
    };
    document.getElementById("bm-cancel").onclick = () => {
      addBar.classList.add('hidden');
      showAddBtn.classList.remove('hidden');
      document.getElementById("bm-url").value = "";
      document.getElementById("bm-label").value = "";
      document.getElementById("bm-img").value = "";
    };

    // --- Add bookmark handler ---
    document.getElementById("bm-add").onclick = function(e) {
      e.preventDefault();
      const url = document.getElementById("bm-url").value.trim();
      const label = document.getElementById("bm-label").value.trim();
      const img = document.getElementById("bm-img").value.trim();
      if (!/^https?:\/\//i.test(url)) {
        alert("Please enter a valid URL (starts with https:// or http://)");
        return;
      }
      if (!label) {
        alert("Please enter a label for your bookmark.");
        return;
      }
      if (!img) {
        alert("Please enter an Image URL (favicon or logo).");
        return;
      }
      const userBms = getUserBookmarks();
      if (userBms.find(bm => bm.url === url)) {
        alert("Bookmark already exists!");
        return;
      }
      userBms.push({url, label, img});
      setUserBookmarks(userBms);
      document.getElementById("bm-url").value = "";
      document.getElementById("bm-label").value = "";
      document.getElementById("bm-img").value = "";
      addBar.classList.add('hidden');
      showAddBtn.classList.remove('hidden');
      renderBookmarks();
    };

    // --- UV Search Bar ---
    function proxifyUrl(url) {
      if (url.startsWith(location.origin + __uv$config.prefix)) return url;
      return __uv$config.prefix + __uv$config.encodeUrl(url);
    }
    function openUvUrl(url) {
      if (window.parent !== window) {
        window.parent.postMessage({ ntNavigate: url }, '*');
      } else {
        window.location.href = proxifyUrl(url);
      }
    }
    window.addEventListener('message', e => {
      if (e.data.ntNavigate) openUvUrl(e.data.ntNavigate);
    });

    const searchEngine = localStorage.getItem('searchEngine') || 'https://www.google.com/search?q=';
    document.getElementById('nt-search-form').addEventListener('submit', e => {
      e.preventDefault();
      let q = document.getElementById('nt-search').value.trim();
      if (!q) return;
      if (!q.includes('://')) {
        if (q.includes('.')) q = 'https://' + q;
        else q = searchEngine + encodeURIComponent(q);
      }
      openUvUrl(q);
      // --- Add to search history in parent
      if (window.parent !== window) {
        window.parent.postMessage({ addSearchHistory: { query: q } }, "*");
      } else {
        let arr = JSON.parse(localStorage.getItem('uv_search_history') || "[]");
        arr.push({query: q, time: (new Date()).toISOString()});
        localStorage.setItem('uv_search_history', JSON.stringify(arr));
      }
    });

    // --- Init ---
    renderBookmarks();
  </script>
</body>
</html>
