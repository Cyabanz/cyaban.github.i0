<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Games Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #181c24; color: #e8eaf0; margin: 0; min-height: 100vh; }
    header { background: #222633; padding: 1.2rem 2vw; display: flex; align-items: center; justify-content: space-between; }
    .app-title { font-size: 2rem; font-weight: 700; color: #90caf9; letter-spacing: 1.5px; }
    .user-info { display: flex; align-items: center; gap: 1rem; }
    .user-info img { border-radius: 50%; width: 38px; height: 38px; object-fit: cover; }
    .games-section { max-width: 970px; margin: 2rem auto; background: #202538; border-radius: 15px; box-shadow: 0 2px 24px #19193a33; padding: 2rem; }
    .games-list { display: flex; flex-wrap: wrap; gap: 1.5rem; justify-content: flex-start; }
    .game-card { background: #232946; border-radius: 12px; width: 210px; box-shadow: 0 1px 14px #0a0a1a22; display: flex; flex-direction: column; overflow: hidden; transition: transform 0.15s; position: relative; }
    .game-card:hover { transform: scale(1.025); box-shadow: 0 4px 24px #90caf955; }
    .game-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; background: #111; }
    .game-details { padding: 1rem; display: flex; flex-direction: column; gap: 0.4rem; }
    .game-title { font-size: 1.1rem; font-weight: 600; color: #fff; }
    .game-meta { font-size: 0.93rem; color: #90caf9; margin-bottom: 0.2rem; }
    .game-categories { margin-bottom: 0.5em; }
    .game-chip { display: inline-block; background: #232946; color: #90caf9; border: 1px solid #90caf9; border-radius: 7px; padding: 0 9px; font-size: 0.84em; margin-right: 0.5em; margin-bottom: 0.2em; }
    .game-actions { display: flex; gap: 0.6rem; margin-top: 0.4rem; align-items: center; }
    .fav-btn { background: none; border: none; color: #ffeb3b; font-size: 1.4rem; cursor: pointer; transition: color 0.17s; margin-right: 0.5rem; }
    .fav-btn.favorited { color: #ffd600; text-shadow: 0 0 7px #ffd60099; }
    .play-btn { background: #90caf9; color: #191c24; border: none; border-radius: 7px; font-weight: 600; font-size: 1rem; padding: 6px 18px; cursor: pointer; transition: background 0.13s; margin-left: auto; }
    .play-btn:hover { background: #1976d2; color: #fff; }
    .history-section, .favorites-section { max-width: 970px; margin: 2rem auto 0; background: #232946; border-radius: 15px; box-shadow: 0 2px 24px #19193a22; padding: 1.2rem 2vw 1.7rem 2vw; }
    h2 { font-weight: 600; color: #90caf9; margin: 0 0 1.1rem 0; letter-spacing: 0.5px; }
    .history-list, .favorites-list { display: flex; gap: 1.2rem; flex-wrap: wrap; }
    .history-entry, .favorite-entry { background: #21243d; border-radius: 10px; padding: 0.7rem 1rem; display: flex; align-items: center; gap: 0.8rem; font-size: 1rem; color: #fff; }
    .history-entry img, .favorite-entry img { width: 36px; height: 36px; border-radius: 7px; object-fit: cover; }
    .logout-btn { background: #2d3748; color: #fff; border: none; border-radius: 7px; font-size: 1rem; padding: 7px 19px; font-weight: 600; cursor: pointer; margin-left: 1rem; }
    .logout-btn:hover { background: #e53935; color: #fff; }
    .google-btn { background: #fff; color: #222; border: none; border-radius: 7px; font-size: 1rem; padding: 10px 32px; font-weight: 600; cursor: pointer; margin: 4rem auto 0 auto; display: block; box-shadow: 0 2px 16px #19193a33; transition: background 0.13s; }
    .google-btn i { color: #ea4335; font-size: 1.1em; margin-right: 0.7em; vertical-align: middle; }
    .google-btn:hover { background: #e3e3e3; }
    /* Preloader Modal Styles */
    .game-preloader-bg { position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: #181c2490; z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .game-preloader { background: #222633; border-radius: 23px; box-shadow: 0 8px 48px #19193a66; max-width: 370px; width: 98vw; padding: 2.2em 1.7em 1.6em 1.7em; display: flex; flex-direction: column; align-items: center; position: relative; animation: fadeInPreloader 0.26s; }
    @keyframes fadeInPreloader { from { opacity: 0; transform: scale(0.97); } to { opacity: 1; transform: scale(1);} }
    .preloader-close { position: absolute; right: 1.2em; top: 1.1em; background: none; border: none; color: #90caf9; font-size: 1.5em; cursor: pointer; }
    .preloader-img { width: 96px; height: 96px; border-radius: 13px; object-fit: cover; margin-bottom: 1em; border: 2px solid #90caf9; }
    .preloader-title { font-size: 1.25em; font-weight: 700; color: #fff; margin-bottom: 0.4em; text-align: center;}
    .preloader-categories { margin-bottom: 0.5em; }
    .preloader-desc { font-size: 1em; color: #b0b7c3; margin-bottom: 1.2em; text-align: center; }
    .preloader-btn-row { display: flex; gap: 0.7em; margin-bottom: 0.9em; }
    .preloader-btn, .preloader-fav-btn { border: none; border-radius: 8px; padding: 0.6em 1.2em; font-size: 1em; font-weight: 600; cursor: pointer; background: #90caf9; color: #191c24; transition: background 0.13s; }
    .preloader-btn:hover, .preloader-fav-btn:hover { background: #1976d2; color: #fff; }
    .preloader-fav-btn.favorited { background: #ffd600; color: #191c24; }
    .preloader-icon-btn { background: none; border: none; color: #90caf9; font-size: 1.34em; cursor: pointer; margin: 0 0.1em; transition: color 0.15s; }
    .preloader-icon-btn.liked { color: #48fa80; }
    .preloader-icon-btn.disliked { color: #fa4c4c; }
    .preloader-likes { display: flex; gap: 0.6em; align-items: center; margin-bottom: 0.7em; }
    .preloader-likes span { font-size: 1em; color: #b0b7c3; }
    .preloader-controls-btn { background: none; border: 1px solid #90caf9; color: #90caf9; border-radius: 8px; padding: 0.4em 1em; font-size: 0.99em; cursor: pointer; transition: all 0.13s; }
    .preloader-controls-btn:hover { background: #232946; }
    .preloader-controls-info { background: #232946; color: #b0b7c3; border-radius: 8px; padding: 1em; margin-top: 1em; font-size: 0.98em; text-align: left;}
    @media (max-width: 700px) {
      .games-section, .history-section, .favorites-section { padding: 1.2rem 1vw 1.7rem 1vw; }
      .games-list, .history-list, .favorites-list { gap: 1rem; }
      .game-card { width: 100%; }
      .game-preloader { max-width: 98vw; }
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase config (replace with yours if needed)
    const firebaseConfig = {
      apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
      authDomain: "fusioncya-cc20a.firebaseapp.com",
      databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
      projectId: "fusioncya-cc20a",
      storageBucket: "fusioncya-cc20a.appspot.com",
      messagingSenderId: "765164293111",
      appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
      measurementId: "G-4DT52P7MPB"
    };
    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- UI ELEMENTS ---
    const $ = s => document.querySelector(s);
    const userInfo = $('#user-info');
    const userPhoto = $('#user-photo');
    const userName = $('#user-name');
    const logoutBtn = $('#logout-btn');
    const googleSignInBtn = $('#google-signin');
    const gamesSection = $('#games-section');
    const gamesList = $('#games-list');
    const favoritesSection = $('#favorites-section');
    const favoritesList = $('#favorites-list');
    const historySection = $('#history-section');
    const historyList = $('#history-list');
    let currentUser = null;
    let userFavorites = [];
    let userHistory = [];
    let GAMES = [];
    let likesCache = {}; // {gameId: {likes: number, dislikes: number}}

    // --- AUTH ---
    function showSignedIn(user) {
      userInfo.style.display = '';
      userPhoto.src = user.photoURL;
      userName.textContent = user.displayName;
      googleSignInBtn.style.display = 'none';
      gamesSection.style.display = '';
      favoritesSection.style.display = '';
      historySection.style.display = '';
      loadUserData();
    }
    function showSignedOut() {
      userInfo.style.display = 'none';
      googleSignInBtn.style.display = '';
      gamesSection.style.display = 'none';
      favoritesSection.style.display = 'none';
      historySection.style.display = 'none';
      gamesList.innerHTML = '';
      favoritesList.innerHTML = '';
      historyList.innerHTML = '';
    }
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) { showSignedIn(user); }
      else { showSignedOut(); }
    });
    googleSignInBtn.onclick = () => {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider).catch(err => alert(err.message));
    };
    logoutBtn.onclick = () => signOut(auth);

    // --- FIREBASE DATA ---
    function userDocRef() {
      if (!currentUser) return null;
      return doc(db, 'users', currentUser.uid);
    }
    async function loadUserData() {
      if (!currentUser) return;
      const docRef = userDocRef();
      const docSnap = await getDoc(docRef);
      userFavorites = [];
      userHistory = [];
      if (docSnap.exists()) {
        const data = docSnap.data();
        userFavorites = data.favorites || [];
        userHistory = data.history || [];
      }
      renderGames();
      renderFavorites();
      renderHistory();
    }
    async function toggleFavorite(gameId) {
      if (!currentUser) return;
      const idx = userFavorites.indexOf(gameId);
      if (idx >= 0) userFavorites.splice(idx, 1);
      else userFavorites.push(gameId);
      await setDoc(userDocRef(), { favorites: userFavorites }, { merge: true });
      renderGames();
      renderFavorites();
    }
    async function addToHistory(gameId) {
      if (!currentUser) return;
      userHistory = userHistory.filter(h => h.id !== gameId);
      userHistory.unshift({ id: gameId, playedAt: Date.now() });
      userHistory = userHistory.slice(0, 20);
      await setDoc(userDocRef(), { history: userHistory }, { merge: true });
      renderHistory();
    }

    // --- GAMES LOADING FROM game.json ---
    async function loadGames() {
      try {
        const resp = await fetch('game.json');
        if (!resp.ok) throw new Error("Could not load games");
        GAMES = await resp.json();
        await loadAllGameLikes();
        if (auth.currentUser) {
          renderGames();
          renderFavorites();
          renderHistory();
        }
      } catch (e) {
        gamesList.innerHTML = `<div style="color:#e53935;font-weight:600;">Failed to load games.json</div>`;
      }
    }

    // --- LIKES/DISLIKES HANDLING ---
    async function loadAllGameLikes() {
      likesCache = {};
      await Promise.all(GAMES.map(async game => {
        let d = await getDoc(doc(db, 'gameLikes', game.id));
        likesCache[game.id] = { likes: 0, dislikes: 0, userLiked: false, userDisliked: false };
        if (d.exists()) {
          likesCache[game.id].likes = d.data().likes || 0;
          likesCache[game.id].dislikes = d.data().dislikes || 0;
          if (currentUser) {
            const liked = d.data().likedUsers || [];
            const disliked = d.data().dislikedUsers || [];
            likesCache[game.id].userLiked = liked.includes(currentUser.uid);
            likesCache[game.id].userDisliked = disliked.includes(currentUser.uid);
          }
        }
      }));
    }
    async function updateGameLike(gameId, likeType) {
      if (!currentUser) return;
      const ref = doc(db, 'gameLikes', gameId);
      const d = await getDoc(ref);
      let likedUsers = [], dislikedUsers = [];
      let likes = 0, dislikes = 0;
      if (d.exists()) {
        likedUsers = d.data().likedUsers || [];
        dislikedUsers = d.data().dislikedUsers || [];
        likes = d.data().likes || 0;
        dislikes = d.data().dislikes || 0;
      }
      // Remove user from both, then add to one
      likedUsers = likedUsers.filter(u => u !== currentUser.uid);
      dislikedUsers = dislikedUsers.filter(u => u !== currentUser.uid);
      if (likeType === 'like') likedUsers.push(currentUser.uid);
      if (likeType === 'dislike') dislikedUsers.push(currentUser.uid);
      likes = likedUsers.length;
      dislikes = dislikedUsers.length;
      await setDoc(ref, { likes, dislikes, likedUsers, dislikedUsers }, { merge: true });
      await loadAllGameLikes();
      renderPreloaderModal(gameId);
    }

    // --- GAMES PRELOADER MODAL ---
    let preloaderElem = null;
    function renderPreloaderModal(gameId) {
      const game = GAMES.find(g => g.id === gameId);
      if (!game) return;
      if (preloaderElem) preloaderElem.remove();
      preloaderElem = document.createElement('div');
      preloaderElem.className = 'game-preloader-bg';
      // Data for like/dislike
      const likesData = likesCache[gameId] || {likes:0,dislikes:0,userLiked:false,userDisliked:false};
      preloaderElem.innerHTML = `
        <div class="game-preloader">
          <button class="preloader-close" title="Close"><i class="bx bx-x"></i></button>
          <img class="preloader-img" src="${game.thumb}" alt="${game.title}">
          <div class="preloader-title">${game.title}</div>
          <div class="preloader-categories">
            ${Array.isArray(game.categories) ? game.categories.map(c => `<span class="game-chip">${c}</span>`).join('') : `<span class="game-chip">${game.category}</span>`}
          </div>
          <div class="preloader-desc">${game.description ? game.description : ''}</div>
          <div class="preloader-likes">
            <button class="preloader-icon-btn ${likesData.userLiked ? 'liked' : ''}" title="Like"><i class='bx bxs-like'></i></button>
            <span>${likesData.likes}</span>
            <button class="preloader-icon-btn ${likesData.userDisliked ? 'disliked' : ''}" title="Dislike"><i class='bx bxs-dislike'></i></button>
            <span>${likesData.dislikes}</span>
          </div>
          <div class="preloader-btn-row">
            <button class="preloader-btn" id="preloader-play">Play</button>
            <button class="preloader-fav-btn${userFavorites.includes(game.id) ? ' favorited' : ''}" id="preloader-fav">
              <i class='bx bxs-star'></i> Favorite
            </button>
            <button class="preloader-btn" id="preloader-fullscreen"><i class='bx bx-fullscreen'></i> Fullscreen</button>
            <button class="preloader-controls-btn" id="preloader-controls"><i class='bx bx-info-circle'></i> Controls</button>
          </div>
          <div class="preloader-controls-info" style="display:none;"></div>
        </div>
      `;
      document.body.appendChild(preloaderElem);
      // Modal events
      preloaderElem.querySelector('.preloader-close').onclick = () => { preloaderElem.remove(); preloaderElem = null; };
      preloaderElem.onclick = e => { if (e.target === preloaderElem) { preloaderElem.remove(); preloaderElem = null; } };
      // Like/Dislike
      preloaderElem.querySelectorAll('.preloader-icon-btn')[0].onclick = async () => { await updateGameLike(game.id, 'like'); };
      preloaderElem.querySelectorAll('.preloader-icon-btn')[1].onclick = async () => { await updateGameLike(game.id, 'dislike'); };
      // Play
      preloaderElem.querySelector('#preloader-play').onclick = () => {
        addToHistory(game.id);
        window.open(game.url, '_blank');
        preloaderElem.remove();
        preloaderElem = null;
      };
      // Favorite
      preloaderElem.querySelector('#preloader-fav').onclick = async () => {
        await toggleFavorite(game.id);
        renderPreloaderModal(game.id); // re-render for icon update
      };
      // Fullscreen
      preloaderElem.querySelector('#preloader-fullscreen').onclick = () => {
        window.open(game.url, '_blank').focus();
      };
      // Controls/Info
      preloaderElem.querySelector('#preloader-controls').onclick = () => {
        const info = preloaderElem.querySelector('.preloader-controls-info');
        if (info.style.display === 'none') {
          info.style.display = '';
          info.textContent = game.controls ? game.controls : 'No controls/instructions provided.';
        } else {
          info.style.display = 'none';
        }
      };
    }

    // --- RENDERING ---
    function renderGames() {
      gamesList.innerHTML = '';
      GAMES.forEach(game => {
        const card = document.createElement('div');
        card.className = 'game-card';
        card.innerHTML = `
          <img class="game-thumb" src="${game.thumb}" alt="${game.title}">
          <div class="game-details">
            <div class="game-title">${game.title}</div>
            <div class="game-categories">
              ${Array.isArray(game.categories) ? game.categories.map(c => `<span class="game-chip">${c}</span>`).join('') : `<span class="game-chip">${game.category}</span>`}
            </div>
            <div class="game-actions">
              <button class="fav-btn${userFavorites.includes(game.id) ? ' favorited' : ''}" title="Favorite">
                <i class='bx bxs-star'></i>
              </button>
              <button class="play-btn">Play</button>
            </div>
          </div>
        `;
        card.querySelector('.fav-btn').onclick = () => toggleFavorite(game.id);
        card.querySelector('.play-btn').onclick = () => renderPreloaderModal(game.id);
        gamesList.appendChild(card);
      });
    }
    function renderFavorites() {
      favoritesList.innerHTML = '';
      if (!userFavorites.length) {
        favoritesList.innerHTML = `<div style="color:#a1a1aa;">No favorites yet.</div>`;
        return;
      }
      userFavorites.forEach(fid => {
        const game = GAMES.find(g => g.id === fid);
        if (!game) return;
        const entry = document.createElement('div');
        entry.className = 'favorite-entry';
        entry.innerHTML = `
          <img src="${game.thumb}" alt="">
          <span>${game.title}</span>
          <button class="fav-btn favorited" title="Remove Favorite"><i class='bx bxs-star'></i></button>
        `;
        entry.querySelector('.fav-btn').onclick = () => toggleFavorite(game.id);
        favoritesList.appendChild(entry);
      });
    }
    function renderHistory() {
      historyList.innerHTML = '';
      if (!userHistory.length) {
        historyList.innerHTML = `<div style="color:#a1a1aa;">No games played yet.</div>`;
        return;
      }
      userHistory.forEach(h => {
        const game = GAMES.find(g => g.id === h.id);
        if (!game) return;
        const entry = document.createElement('div');
        entry.className = 'history-entry';
        entry.innerHTML = `
          <img src="${game.thumb}" alt="">
          <span>${game.title}</span>
          <span style="font-size:0.93em;color:#90caf9;">${new Date(h.playedAt).toLocaleString()}</span>
          <button class="play-btn" style="padding:3px 14px;font-size:0.95em;">Play</button>
        `;
        entry.querySelector('.play-btn').onclick = () => renderPreloaderModal(game.id);
        historyList.appendChild(entry);
      });
    }

    // --- INITIALIZE ---
    window.addEventListener('DOMContentLoaded', () => { loadGames(); });
  </script>
</head>
<body>
  <header>
    <span class="app-title">Games Portal</span>
    <div class="user-info" id="user-info" style="display:none;">
      <img id="user-photo" alt="Profile">
      <span id="user-name"></span>
      <button class="logout-btn" id="logout-btn">Logout</button>
    </div>
  </header>
  <button class="google-btn" id="google-signin" style="display:none;">
    <i class='bx bxl-google'></i> Sign in with Google
  </button>
  <main>
    <section class="games-section" id="games-section" style="display:none;">
      <h2>All Games</h2>
      <div class="games-list" id="games-list"></div>
    </section>
    <section class="favorites-section" id="favorites-section" style="display:none;">
      <h2><i class='bx bxs-star'></i> Favorite Games</h2>
      <div class="favorites-list" id="favorites-list"></div>
    </section>
    <section class="history-section" id="history-section" style="display:none;">
      <h2><i class='bx bx-history'></i> Play History</h2>
      <div class="history-list" id="history-list"></div>
    </section>
  </main>
</body>
</html>
