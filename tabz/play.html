<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Play Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #181c24; color: #e8eaf0; margin: 0; min-height: 100vh;}
    .game-header { display: flex; align-items: center; gap: 1.4em; padding: 2em 4vw 1em 4vw; }
    .game-thumb { width: 62px; height: 62px; border-radius: 12px; object-fit: cover;}
    .game-title { font-size: 2em; font-weight: 700; color: #90caf9;}
    .game-categories {margin-top: 0.7em;}
    .game-chip { display: inline-block; background: #232946; color: #90caf9; border: 1px solid #90caf9; border-radius: 7px; padding: 0 9px; font-size: 0.9em; margin-right: 0.5em;}
    .game-actions {display: flex; gap: 1.1em; margin:1.6em 0 1em 0; align-items: center; flex-wrap: wrap;}
    .action-btn { border: none; border-radius: 8px; padding: 0.55em 1.2em; font-size: 1.05em; font-weight: 600; cursor: pointer; background: #90caf9; color: #191c24; transition: background 0.13s;}
    .action-btn:hover { background: #1976d2; color: #fff; }
    .fav-btn.favorited { background: #ffd600; color: #191c24; }
    .icon-btn { background: none; border: none; color: #90caf9; font-size: 1.33em; cursor: pointer; margin: 0 0.2em; transition: color 0.15s;}
    .icon-btn.liked { color: #48fa80; }
    .icon-btn.disliked { color: #fa4c4c;}
    .likes-row { display: flex; gap: 0.7em; align-items: center; }
    .likes-row span { font-size: 1em; color: #b0b7c3;}
    .game-controls-btn { background: none; border: 1px solid #90caf9; color: #90caf9; border-radius: 8px; padding: 0.4em 1em; font-size: 0.99em; cursor: pointer; transition: all 0.13s;}
    .game-controls-btn:hover { background: #232946;}
    .game-controls-info { background: #232946; color: #b0b7c3; border-radius: 8px; padding: 1em; margin-top: 1em; font-size: 0.98em; max-width: 470px;}
    .game-desc { margin: 1.8em 0 1em 0; font-size: 1.13em; color: #b0b7c3; }
    .game-iframe-wrap { width: 100vw; max-width: 1090px; margin: 1.1em auto 0 auto; display: flex; justify-content: center;}
    .game-iframe { width: 100%; min-height: 64vw; max-height: 650px; max-width: 900px; border: 0; border-radius: 16px; box-shadow: 0 4px 32px #1d1d2a55;}
    .back-btn { margin: 2em 0 0 4vw; background: none; border: none; color: #90caf9; font-size: 1.1em; cursor: pointer; }
    .comment-section { max-width: 900px; margin: 2em auto 3em auto; background: #232946; border-radius: 16px; box-shadow: 0 2px 24px #19193a33; padding: 2em 1em 2.5em 1em;}
    .comment-title { font-size: 1.27em; font-weight: 600; color: #90caf9; margin-bottom: 1em;}
    .comment-form { display: flex; flex-direction: column; gap: 0.7em; margin-bottom: 2em;}
    .comment-input { border: 1px solid #90caf9; border-radius: 8px; background: #181c24; color: #e8eaf0; font-size: 1em; padding: 0.6em 1em; resize: vertical; min-height: 55px; }
    .comment-input:focus { border-color: #1976d2; outline: none;}
    .comment-post-btn { align-self: flex-end; background: #90caf9; color: #191c24; border: none; border-radius: 7px; font-weight: 600; font-size: 1em; padding: 7px 22px; cursor: pointer; transition: background 0.13s;}
    .comment-post-btn:disabled { background: #444b5e; color: #b0b7c3; cursor: not-allowed;}
    .comments-list { display: flex; flex-direction: column; gap: 1.6em; }
    .comment { background: #202538; border-radius: 10px; padding: 1em 1.1em 0.8em 1.1em; display: flex; gap: 1em;}
    .comment-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; margin-top: 0.2em;}
    .comment-main { flex: 1; }
    .comment-user { font-weight: 600; color: #90caf9; font-size: 1em;}
    .comment-date { font-size: 0.93em; color: #b0b7c3; margin-left: 0.7em;}
    .comment-text { margin: 0.5em 0 0.7em 0; font-size: 1.05em;}
    .comment-actions { display: flex; gap: 0.8em; align-items: center; }
    .comment-like-btn { background: none; border: none; color: #90caf9; font-size: 1.25em; cursor: pointer; transition: color 0.13s;}
    .comment-like-btn.liked { color: #48fa80;}
    .comment-likes-count { font-size: 0.98em; color: #e8eaf0;}
    .comment-error { color: #e53935; font-size: 0.98em; margin-top: 0.2em;}
    @media (max-width: 900px) {
      .game-iframe { min-height: 70vw; max-width: 98vw; }
      .game-header { flex-direction: column; align-items: flex-start; gap: 0.7em;}
      .comment-section { padding: 1.1em 0.3em 2em 0.3em;}
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, updateDoc, arrayUnion, arrayRemove, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
      authDomain: "fusioncya-cc20a.firebaseapp.com",
      databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
      projectId: "fusioncya-cc20a",
      storageBucket: "fusioncya-cc20a.appspot.com",
      messagingSenderId: "765164293111",
      appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
      measurementId: "G-4DT52P7MPB"
    };
    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI
    const $ = s => document.querySelector(s);
    let GAMES = [];
    let game = null;
    let likesData = {likes:0,dislikes:0,userLiked:false,userDisliked:false};
    let userFavorites = [], userHistory = [];
    let currentUser = null;
    let commentsUnsubscribe = null;
    let commentLikeCache = {}; // {commentId: true}

    // Bad word filter (client-side, simple, customizable)
    const BAD_WORDS = [
      'fuck','shit','bitch','cunt','nigger','fag','asshole','bastard','slut','dick','pussy','whore','faggot','cock','retard','cum','rape'
      // Add/remove as needed
    ];
    function containsBadWord(text) {
      const lower = text.toLowerCase();
      return BAD_WORDS.some(word => lower.includes(word));
    }

    // Get ID from URL
    function getGameId() {
      const url = new URL(window.location.href);
      return url.searchParams.get('id');
    }

    // ----- Firebase User Data -----
    function userDocRef() {
      if (!currentUser) return null;
      return doc(db, 'users', currentUser.uid);
    }
    async function loadUserData() {
      if (!currentUser) return;
      const docRef = userDocRef();
      const docSnap = await getDoc(docRef);
      userFavorites = [];
      userHistory = [];
      if (docSnap.exists()) {
        const data = docSnap.data();
        userFavorites = data.favorites || [];
        userHistory = data.history || [];
      }
      renderActions();
    }
    async function toggleFavorite() {
      if (!currentUser) return;
      const idx = userFavorites.indexOf(game.id);
      if (idx >= 0) userFavorites.splice(idx, 1);
      else userFavorites.push(game.id);
      await setDoc(userDocRef(), { favorites: userFavorites }, { merge: true });
      renderActions();
    }
    async function addToHistory() {
      if (!currentUser) return;
      userHistory = userHistory.filter(h => h.id !== game.id);
      userHistory.unshift({ id: game.id, playedAt: Date.now() });
      userHistory = userHistory.slice(0, 20);
      await setDoc(userDocRef(), { history: userHistory }, { merge: true });
    }

    // ----- Likes/Dislikes -----
    async function loadGameLikes() {
      let d = await getDoc(doc(db, 'gameLikes', game.id));
      likesData = {likes:0,dislikes:0,userLiked:false,userDisliked:false};
      if (d.exists()) {
        likesData.likes = d.data().likes || 0;
        likesData.dislikes = d.data().dislikes || 0;
        if (currentUser) {
          const liked = d.data().likedUsers || [];
          const disliked = d.data().dislikedUsers || [];
          likesData.userLiked = liked.includes(currentUser.uid);
          likesData.userDisliked = disliked.includes(currentUser.uid);
        }
      }
      renderActions();
    }
    async function updateGameLike(likeType) {
      if (!currentUser) return;
      const ref = doc(db, 'gameLikes', game.id);
      const d = await getDoc(ref);
      let likedUsers = [], dislikedUsers = [];
      let likes = 0, dislikes = 0;
      if (d.exists()) {
        likedUsers = d.data().likedUsers || [];
        dislikedUsers = d.data().dislikedUsers || [];
        likes = d.data().likes || 0;
        dislikes = d.data().dislikes || 0;
      }
      likedUsers = likedUsers.filter(u => u !== currentUser.uid);
      dislikedUsers = dislikedUsers.filter(u => u !== currentUser.uid);
      if (likeType === 'like') likedUsers.push(currentUser.uid);
      if (likeType === 'dislike') dislikedUsers.push(currentUser.uid);
      likes = likedUsers.length;
      dislikes = dislikedUsers.length;
      await setDoc(ref, { likes, dislikes, likedUsers, dislikedUsers }, { merge: true });
      await loadGameLikes();
    }

    // ----- Render -----
    function renderGame() {
      if (!game) {
        $('main').innerHTML = "<div style='color:#e53935;font-size:1.3em;margin:2em;'>Game not found.</div>";
        return;
      }
      document.title = game.title + ' | Play Game';
      $('.game-title').textContent = game.title;
      $('.game-thumb').src = game.thumb;
      $('.game-desc').textContent = game.description || '';
      $('.game-categories').innerHTML =
        (Array.isArray(game.categories) ? game.categories.map(c => `<span class="game-chip">${c}</span>`).join('') : `<span class="game-chip">${game.category}</span>`);
      // Controls
      $('.game-controls-info').style.display = 'none';
      $('.game-controls-info').textContent = game.controls ? game.controls : "No controls/instructions provided.";
      // Iframe or fallback
      let iframe = $('.game-iframe');
      if(iframe) iframe.remove();
      iframe = document.createElement('iframe');
      iframe.className = 'game-iframe';
      iframe.setAttribute('allowfullscreen','true');
      iframe.src = game.url;
      $('.game-iframe-wrap').appendChild(iframe);
    }
    function renderActions() {
      // Like/dislike
      $('.like-btn').classList.toggle('liked', likesData.userLiked);
      $('.dislike-btn').classList.toggle('disliked', likesData.userDisliked);
      $('.like-count').textContent = likesData.likes;
      $('.dislike-count').textContent = likesData.dislikes;
      // Fav
      $('.fav-btn').classList.toggle('favorited', userFavorites.includes(game.id));
    }

    // ----- Listeners -----
    function setListeners() {
      $('.play-btn').onclick = () => {
        addToHistory();
        const iframe = $('.game-iframe');
        if (iframe) iframe.contentWindow.focus();
      };
      $('.fav-btn').onclick = () => toggleFavorite();
      $('.like-btn').onclick = () => updateGameLike('like');
      $('.dislike-btn').onclick = () => updateGameLike('dislike');
      $('.fullscreen-btn').onclick = () => {
        window.open(game.url, '_blank').focus();
      };
      $('.game-controls-btn').onclick = () => {
        const info = $('.game-controls-info');
        if (info.style.display === 'none') info.style.display = '';
        else info.style.display = 'none';
      };
      $('.back-btn').onclick = () => window.location.href = 'games.html';
    }

    // ----- Auth -----
    function showAuthBtn() {
      $('.auth-btn').style.display = '';
      $('.user-photo').style.display = 'none';
      $('.user-name').style.display = 'none';
      $('.logout-btn').style.display = 'none';
      $('.comment-form').style.display = 'none';
      $('.comment-form-info').style.display = '';
    }
    function showUser(user) {
      $('.auth-btn').style.display = 'none';
      $('.user-photo').src = user.photoURL;
      $('.user-photo').style.display = '';
      $('.user-name').textContent = user.displayName;
      $('.user-name').style.display = '';
      $('.logout-btn').style.display = '';
      $('.comment-form').style.display = '';
      $('.comment-form-info').style.display = 'none';
    }
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        showUser(user);
        loadUserData();
        loadGameLikes();
        setupComments();
      } else {
        showAuthBtn();
        setupComments();
      }
    });
    $('.auth-btn').onclick = () => {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider).catch(err => alert(err.message));
    };
    $('.logout-btn').onclick = () => signOut(auth);

    // ----- Comments -----
    function setupComments() {
      // cleanup
      if (commentsUnsubscribe) commentsUnsubscribe();
      renderCommentsList([]);
      if (!game) return;
      // Listen for comments (realtime)
      const q = query(collection(db, 'games', game.id, 'comments'), orderBy('createdAt', 'desc'));
      commentsUnsubscribe = onSnapshot(q, snap => {
        let comments = [];
        snap.forEach(doc => {
          comments.push({ id: doc.id, ...doc.data() });
        });
        renderCommentsList(comments);
      });
    }
    async function postComment(text) {
      if (!currentUser) return;
      if (!game) return;
      if (containsBadWord(text)) throw new Error("Inappropriate language detected.");
      await addDoc(collection(db, 'games', game.id, 'comments'), {
        text,
        user: {
          uid: currentUser.uid,
          name: currentUser.displayName,
          photo: currentUser.photoURL || "",
        },
        createdAt: serverTimestamp(),
        likes: [],
      });
    }
    function renderCommentsList(comments) {
      const list = $('.comments-list');
      list.innerHTML = '';
      if (!comments.length) {
        list.innerHTML = `<div style="color:#888b9a;padding:1.4em;text-align:center;">No comments yet. Be the first to comment!</div>`;
        return;
      }
      comments.forEach(comment => {
        const div = document.createElement('div');
        div.className = 'comment';
        const likedByMe = comment.likes && currentUser ? comment.likes.includes(currentUser.uid) : false;
        div.innerHTML = `
          <img class="comment-avatar" src="${comment.user.photo || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(comment.user.name)}" alt="">
          <div class="comment-main">
            <span class="comment-user">${comment.user.name || 'Unknown'}</span>
            <span class="comment-date">${comment.createdAt && comment.createdAt.toDate ? comment.createdAt.toDate().toLocaleString() : ''}</span>
            <div class="comment-text">${escapeHTML(comment.text)}</div>
            <div class="comment-actions">
              <button class="comment-like-btn${likedByMe ? ' liked' : ''}" title="Like"><i class='bx bxs-like'></i></button>
              <span class="comment-likes-count">${comment.likes ? comment.likes.length : 0}</span>
            </div>
          </div>
        `;
        // Like button event
        div.querySelector('.comment-like-btn').onclick = () => handleLikeComment(comment.id, likedByMe, comment.likes || []);
        list.appendChild(div);
      });
    }
    async function handleLikeComment(commentId, likedByMe, likesArr) {
      if (!currentUser) return;
      const ref = doc(db, 'games', game.id, 'comments', commentId);
      let newLikes = Array.isArray(likesArr) ? [...likesArr] : [];
      if (likedByMe) {
        newLikes = newLikes.filter(uid => uid !== currentUser.uid);
      } else {
        newLikes.push(currentUser.uid);
      }
      await updateDoc(ref, { likes: newLikes });
    }
    // Escape HTML for comments
    function escapeHTML(str) {
      return str.replace(/[<>&"'`]/g, c => ({
        '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;','`':'&#96;'
      })[c]);
    }

    // ----- Comment Form -----
    window.addEventListener('DOMContentLoaded', async () => {
      // Auth user (UI)
      showAuthBtn();
      // Fetch games
      const resp = await fetch('game.json');
      GAMES = await resp.json();
      const gameId = getGameId();
      game = GAMES.find(g => g.id === gameId);
      renderGame();
      setListeners();
      if (auth.currentUser) {
        loadUserData();
        loadGameLikes();
        setupComments();
      } else {
        setupComments();
      }
      // Comment form
      $('.comment-input').oninput = () => {
        $('.comment-post-btn').disabled = !$('.comment-input').value.trim();
        $('.comment-error').textContent = '';
      };
      $('.comment-form').onsubmit = async e => {
        e.preventDefault();
        const text = $('.comment-input').value.trim();
        if (!text) return;
        if (containsBadWord(text)) {
          $('.comment-error').textContent = "Please avoid inappropriate language.";
          return;
        }
        $('.comment-post-btn').disabled = true;
        try {
          await postComment(text);
          $('.comment-input').value = '';
          $('.comment-error').textContent = '';
        } catch (err) {
          $('.comment-error').textContent = err.message || "Failed to post comment.";
        }
        $('.comment-post-btn').disabled = false;
      };
    });
  </script>
</head>
<body>
  <button class="back-btn"><i class='bx bx-arrow-back'></i> Back to games</button>
  <div class="game-header">
    <img class="game-thumb" src="" alt="Game">
    <div>
      <div class="game-title"></div>
      <div class="game-categories"></div>
      <div class="likes-row">
        <button class="icon-btn like-btn" title="Like"><i class='bx bxs-like'></i></button>
        <span class="like-count">0</span>
        <button class="icon-btn dislike-btn" title="Dislike"><i class='bx bxs-dislike'></i></button>
        <span class="dislike-count">0</span>
        <button class="action-btn fav-btn" title="Favorite"><i class='bx bxs-star'></i> Favorite</button>
        <button class="action-btn fullscreen-btn" title="Fullscreen"><i class='bx bx-fullscreen'></i> Fullscreen</button>
        <button class="game-controls-btn" title="Controls"><i class='bx bx-info-circle'></i> Controls</button>
      </div>
      <div class="game-controls-info" style="display:none;"></div>
    </div>
  </div>
  <div class="game-desc"></div>
  <div class="game-iframe-wrap"></div>
  <div class="game-actions">
    <button class="action-btn play-btn"><i class='bx bx-play'></i> Play</button>
    <button class="action-btn auth-btn" style="display:none;"><i class='bx bxl-google'></i> Sign in with Google</button>
    <img class="user-photo" style="display:none;width:32px;height:32px;border-radius:50%;vertical-align:middle;">
    <span class="user-name" style="display:none;margin-left:0.6em;"></span>
    <button class="logout-btn" style="display:none;">Logout</button>
  </div>
  <main>
    <div class="comment-section">
      <div class="comment-title">Comments</div>
      <form class="comment-form" style="display:none;">
        <textarea class="comment-input" placeholder="Write a comment..." maxlength="500"></textarea>
        <button class="comment-post-btn" type="submit" disabled>Post</button>
        <div class="comment-error"></div>
      </form>
      <div class="comment-form-info" style="color:#b0b7c3;display:none;">Sign in to post a comment.</div>
      <div class="comments-list"></div>
    </div>
  </main>
</body>
</html>
