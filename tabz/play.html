<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Play Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #181c24; color: #e8eaf0; margin: 0; }
    .comment-section { max-width: 900px; margin: 2.5em auto 3em auto; background: #232946; border-radius: 16px; padding: 2em 1em 2.5em 1em; }
    .comment-form { display: flex; flex-direction: column; gap: 0.7em; margin-bottom: 2em; }
    .comment-stars-selector { margin-bottom: 0.5em; color: #ffd600; font-size: 1.15em; display: flex; align-items: center; gap: 0.42em; }
    .comment-stars { display: flex; gap: 0.08em; }
    .star { font-size: 1.5em; color: #ffd600; opacity: 0.38; cursor: pointer; user-select: none; transition: opacity 0.13s, color 0.13s; }
    .star.filled { opacity: 1; color: #ffd600; }
    .star.selected { opacity: 1; color: #90caf9; }
    .star-value-preview { color: #90caf9; font-size: 1.1em; margin-left: 0.8em; }
    .comment-input { border-radius: 8px; border: none; padding: 0.7em; font-size: 1.1em; background: #181c24; color: #fff; resize: vertical; min-height: 3em; }
    .comment-post-btn { border: none; background: #ffd600; color: #181c24; font-weight: 700; border-radius: 8px; padding: 0.6em 1.8em; font-size: 1.08em; cursor: pointer; }
    .comment-post-btn:disabled { background: #b0b7c3; color: #232946; cursor: not-allowed; }
    .comment-error { color: #e53935; font-weight: 600; min-height: 1.5em; }
    .comments-list { margin-top: 2.2em; display: flex; flex-direction: column; gap: 1.5em; }
    .comment { background: #1a1d2a; border-radius: 8px; padding: 1em; }
    .comment .stars { margin-bottom: 0.2em; }
    .comment .stars .star { font-size: 1.15em; }
    .comment .text { font-size: 1.06em; color: #ffd600; }
    .comment .date { color: #b0b7c3; font-size: 0.92em; }
    /* The rest of your page's styles, header, stars, etc, can go here... */
  </style>
</head>
<body>
  <!-- ... your top section ... -->
  <main>
    <div class="comment-section">
      <div class="comment-title">Comments</div>
      <form class="comment-form">
        <div class="comment-stars-selector">
          Rate this game:
          <span class="comment-stars"></span>
          <span class="star-value-preview">0</span>
        </div>
        <textarea class="comment-input" placeholder="Write a comment..." maxlength="500"></textarea>
        <button class="comment-post-btn" type="submit" disabled>Post</button>
        <div class="comment-error"></div>
      </form>
      <div class="comments-list"></div>
    </div>
  </main>
  <script type="module">
    // -- Firebase Setup --
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
      authDomain: "fusioncya-cc20a.firebaseapp.com",
      projectId: "fusioncya-cc20a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- Bulletproof Comment Star Picker, completely isolated ---
    let commentStarRating = 0;
    function renderCommentStarsSelector(hover=0) {
      const starsWrap = document.querySelector('.comment-stars');
      if (!starsWrap) return;
      starsWrap.innerHTML = '';
      let fill = hover || commentStarRating;
      for (let i=1; i<=5; i++) {
        const s = document.createElement('span');
        s.className = 'star' + (i <= fill ? ' filled' : '');
        s.textContent = '★';
        s.addEventListener('mouseenter', () => renderCommentStarsSelector(i));
        s.addEventListener('mouseleave', () => renderCommentStarsSelector(0));
        s.addEventListener('click', () => {
          commentStarRating = i;
          document.querySelector('.star-value-preview').textContent = commentStarRating;
          renderCommentStarsSelector();
          updatePostButton();
        });
        starsWrap.appendChild(s);
      }
      document.querySelector('.star-value-preview').textContent = commentStarRating;
    }
    renderCommentStarsSelector();

    function updatePostButton() {
      const hasText = document.querySelector('.comment-input').value.trim().length > 0;
      document.querySelector('.comment-post-btn').disabled = !(hasText && commentStarRating > 0);
    }

    // Enable/disable post button based on textarea and star
    document.querySelector('.comment-input').addEventListener('input', updatePostButton);

    // --- Comments in Firestore (all comments are in "games/testgame/comments" subcollection) ---
    const COMMENTS_COLLECTION = "games/testgame/comments";

    // --- Render comments ---
    function renderCommentsList(comments) {
      const list = document.querySelector('.comments-list');
      list.innerHTML = '';
      if (comments.length === 0) {
        list.innerHTML = '<div style="color:#888b9a;text-align:center;padding:2em;">No comments yet.</div>';
        return;
      }
      for (const comment of comments) {
        const div = document.createElement('div');
        let stars = "";
        for (let i=1; i<=5; i++) {
          stars += `<span class="star"${i <= (comment.stars || 0) ? ' style="opacity:1"' : ' style="opacity:0.3"'}>★</span>`;
        }
        div.innerHTML = `<div class="stars">${stars}</div>
          <div class="text">${comment.text}</div>
          <div class="date">${comment.createdAt && comment.createdAt.toDate ? comment.createdAt.toDate().toLocaleString() : ''}</div>`;
        list.appendChild(div);
      }
    }

    // --- Live Firestore comments listener ---
    const q = query(collection(db, COMMENTS_COLLECTION), orderBy("createdAt", "desc"));
    onSnapshot(q, snap => {
      const comments = [];
      snap.forEach(doc => comments.push(doc.data()));
      renderCommentsList(comments);
    });

    // --- Submit handler ---
    document.querySelector('.comment-form').onsubmit = async e => {
      e.preventDefault();
      const text = document.querySelector('.comment-input').value.trim();
      if (!text) return;
      if (commentStarRating === 0) {
        document.querySelector('.comment-error').textContent = "Select a star rating.";
        return;
      }
      try {
        await addDoc(collection(db, COMMENTS_COLLECTION), {
          text,
          stars: commentStarRating,
          createdAt: serverTimestamp()
        });
        commentStarRating = 0;
        document.querySelector('.comment-input').value = '';
        document.querySelector('.comment-error').textContent = '';
        renderCommentStarsSelector();
        updatePostButton();
      } catch (e) {
        document.querySelector('.comment-error').textContent = "Failed to post comment: " + e.message;
      }
    };

    // --- If you want to hide the comment form for non-signed-in users, use this:
    // onAuthStateChanged(auth, user => {
    //   document.querySelector('.comment-form').style.display = user ? "" : "none";
    // });

  </script>
</body>
</html>
