<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Play Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1e253e 0%, #181c24 100%);
      color: #e8eaf0;
      margin: 0;
      min-height: 100vh;
    }
    .back-btn {
      margin: 2em 0 0 2vw;
      background: none;
      border: none;
      color: #90caf9;
      font-size: 1.1em;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.1em;
      transition: color 0.15s;
      display: flex;
      align-items: center;
      gap: 0.3em;
    }
    .back-btn:hover {
      color: #fff;
      text-decoration: underline;
    }
    .game-header {
      display: flex;
      align-items: flex-start;
      gap: 2.5em;
      padding: 2em 4vw 1.3em 4vw;
      max-width: 1100px;
      margin: 0 auto;
    }
    .game-thumb {
      width: 84px;
      height: 84px;
      border-radius: 18px;
      object-fit: cover;
      box-shadow: 0 4px 20px #19193a33;
      border: 3px solid #232946;
      background: #151922;
    }
    .game-meta-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.4em;
    }
    .game-title {
      font-size: 2.2em;
      font-weight: 700;
      color: #90caf9;
      letter-spacing: 0.02em;
      margin-bottom: 0.15em;
    }
    .game-categories {
      margin-top: 0.1em;
      margin-bottom: 0.2em;
    }
    .game-chip {
      display: inline-block;
      background: #232946;
      color: #90caf9;
      border: 1px solid #90caf9;
      border-radius: 7px;
      padding: 0 11px;
      font-size: 0.97em;
      margin-right: 0.5em;
      margin-bottom: 0.2em;
    }
    .game-plays {
      font-size: 1.1em;
      color: #f3e079;
      background: #252b43;
      padding: 0.25em 1.1em 0.25em 0.7em;
      border-radius: 7px;
      display: inline-flex;
      align-items: center;
      gap: 0.4em;
      margin: 0.65em 0 0.25em 0;
      font-weight: 600;
      box-shadow: 0 1px 8px #19193a18;
      letter-spacing: 0.01em;
    }
    .game-plays i {
      color: #ffd600;
      font-size: 1.13em;
      margin-right: 0.1em;
    }
    .likes-row {
      display: flex;
      gap: 1.3em;
      align-items: center;
      margin-top: 0.7em;
      margin-bottom: 0.2em;
    }
    .likes-row button {
      font-size: 1.25em;
    }
    .like-count, .dislike-count {
      min-width: 16px;
      display: inline-block;
      text-align: center;
      font-size: 1.07em;
      font-weight: 600;
      color: #90caf9;
    }
    .icon-btn {
      background: none;
      border: none;
      color: #90caf9;
      font-size: 1.42em;
      cursor: pointer;
      margin: 0 0.2em;
      padding: 0.09em 0.22em;
      border-radius: 50%;
      transition: color 0.15s, background 0.12s;
    }
    .icon-btn.liked { color: #48fa80; background: #222e29;}
    .icon-btn.disliked { color: #fa4c4c; background: #2c1d1d;}
    .icon-btn:active { background: #232946; }

    .action-btn {
      border: none;
      border-radius: 7px;
      padding: 0.52em 1.4em;
      font-size: 1.07em;
      font-weight: 700;
      cursor: pointer;
      background: #90caf9;
      color: #191c24;
      transition: background 0.13s, color 0.14s;
      margin-right: 0.5em;
      margin-top: 0.2em;
    }
    .action-btn:hover { background: #1976d2; color: #fff; }
    .fav-btn.favorited { background: #ffd600; color: #191c24; }
    .fullscreen-btn { background: #252b43; color: #90caf9;}
    .fullscreen-btn:hover { background: #191c24;}
    .game-controls-btn { background: #252b43; color: #90caf9;}
    .game-controls-btn:hover { background: #191c24;}
    .game-controls-info {
      background: #232946;
      color: #b0b7c3;
      border-radius: 8px;
      padding: 1em 1.3em;
      margin-top: 1em;
      font-size: 1em;
      max-width: 470px;
      box-shadow: 0 1px 9px #19193a28;
    }
    .game-desc {
      margin: 1.8em auto 1em auto;
      font-size: 1.13em;
      color: #b0b7c3;
      max-width: 800px;
      line-height: 1.56;
      letter-spacing: 0.01em;
    }
    .game-iframe-wrap {
      width: 100vw;
      max-width: 1090px;
      margin: 1.1em auto 0 auto;
      display: flex;
      justify-content: center;
    }
    .game-iframe {
      width: 100%;
      min-height: 64vw;
      max-height: 650px;
      max-width: 900px;
      border: 0;
      border-radius: 16px;
      box-shadow: 0 4px 32px #1d1d2a55;
      background: #111;
    }
    .game-actions {
      display: flex;
      gap: 1em;
      align-items: center;
      justify-content: flex-end;
      max-width: 1090px;
      margin: 1em auto 0 auto;
      padding: 0 4vw;
    }
    .user-photo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-left: 0.7em;
      object-fit: cover;
      border: 2px solid #232946;
      background: #151922;
      vertical-align: middle;
    }
    .user-name {
      margin-left: 0.65em;
      font-weight: 600;
      color: #90caf9;
      font-size: 1em;
    }
    .logout-btn {
      background: #2d3748;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 1em;
      padding: 7px 19px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 1rem;
      transition: background 0.13s;
    }
    .logout-btn:hover { background: #e53935; color: #fff; }
    .auth-btn {
      background: #fff;
      color: #222;
      border: none;
      border-radius: 7px;
      font-size: 1em;
      padding: 8px 20px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 16px #19193a22;
      transition: background 0.13s;
      margin-left: 0.5em;
    }
    .auth-btn i { color: #ea4335; font-size: 1.1em; margin-right: 0.6em; vertical-align: middle; }
    .auth-btn:hover { background: #e3e3e3; }

    .comment-section {
      max-width: 900px;
      margin: 2.5em auto 3em auto;
      background: #232946;
      border-radius: 16px;
      box-shadow: 0 2px 24px #19193a33;
      padding: 2em 1em 2.5em 1em;
    }
    .comment-title {
      font-size: 1.27em;
      font-weight: 700;
      color: #90caf9;
      margin-bottom: 1em;
      letter-spacing: 0.04em;
    }
    .comment-form {
      display: flex;
      flex-direction: column;
      gap: 0.7em;
      margin-bottom: 2em;
    }
    .comment-input {
      border: 1px solid #90caf9;
      border-radius: 8px;
      background: #181c24;
      color: #e8eaf0;
      font-size: 1em;
      padding: 0.6em 1em;
      resize: vertical;
      min-height: 55px;
      font-family: 'Inter', sans-serif;
    }
    .comment-input:focus { border-color: #1976d2; outline: none;}
    .comment-post-btn {
      align-self: flex-end;
      background: #90caf9;
      color: #191c24;
      border: none;
      border-radius: 7px;
      font-weight: 600;
      font-size: 1em;
      padding: 7px 22px;
      cursor: pointer;
      transition: background 0.13s;
      margin-top: 0.3em;
    }
    .comment-post-btn:disabled { background: #444b5e; color: #b0b7c3; cursor: not-allowed;}
    .comment-form-info {
      color: #b0b7c3;
      font-size: 1em;
      margin-bottom: 1.2em;
      text-align: center;
    }
    .comments-list {
      display: flex;
      flex-direction: column;
      gap: 1.6em;
      margin-top: 0.7em;
    }
    .comment {
      background: #202538;
      border-radius: 10px;
      padding: 1em 1.1em 0.8em 1.1em;
      display: flex;
      gap: 1em;
      box-shadow: 0 1px 7px #19193a18;
    }
    .comment-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      margin-top: 0.2em;
      border: 2px solid #252b43;
      background: #181c24;
    }
    .comment-main { flex: 1; }
    .comment-user {
      font-weight: 600;
      color: #90caf9;
      font-size: 1em;
      letter-spacing: 0.01em;
    }
    .comment-date {
      font-size: 0.93em;
      color: #b0b7c3;
      margin-left: 0.7em;
      font-weight: 500;
    }
    .comment-text {
      margin: 0.5em 0 0.7em 0;
      font-size: 1.05em;
      line-height: 1.5;
      word-break: break-word;
    }
    .comment-actions {
      display: flex;
      gap: 0.8em;
      align-items: center;
    }
    .comment-like-btn {
      background: none;
      border: none;
      color: #90caf9;
      font-size: 1.25em;
      cursor: pointer;
      transition: color 0.13s;
      padding: 0.09em 0.22em;
      border-radius: 50%;
    }
    .comment-like-btn.liked { color: #48fa80;}
    .comment-likes-count {
      font-size: 0.98em;
      color: #e8eaf0;
      min-width: 14px;
      text-align: center;
      font-weight: 600;
    }
    .comment-admin-delete-btn {
      background: none;
      border: none;
      color: #e53935;
      font-size: 1.1em;
      cursor: pointer;
      margin-left: 0.7em;
      font-weight: 600;
      padding: 0.18em 0.7em;
      border-radius: 5px;
      transition: color 0.13s, background 0.13s;
    }
    .comment-admin-delete-btn:hover {
      text-decoration: underline;
      color: #ff1744;
      background: #2c1d1d;
    }
    .comment-deleted {
      color: #b0b7c3;
      font-style: italic;
      font-size: 1em;
      margin: 0.8em 0;
      padding-left: 5.3em;
    }
    .comment-error {
      color: #e53935;
      font-size: 0.98em;
      margin-top: 0.2em;
      font-weight: 600;
      text-align: right;
    }
    @media (max-width: 1100px) {
      .game-header { flex-direction: column; align-items: flex-start; gap: 1.2em; padding: 2em 2vw 1.3em 2vw; }
      .game-actions { padding: 0 2vw; }
    }
    @media (max-width: 900px) {
      .game-iframe { min-height: 70vw; max-width: 98vw; }
      .comment-section { padding: 1.1em 0.3em 2em 0.3em;}
    }
    @media (max-width: 600px) {
      .game-header { gap: 0.8em; padding: 1.3em 1vw 0.8em 1vw;}
      .game-thumb { width: 64px; height: 64px;}
      .game-title { font-size: 1.17em;}
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, updateDoc, serverTimestamp, query, orderBy, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
      authDomain: "fusioncya-cc20a.firebaseapp.com",
      databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
      projectId: "fusioncya-cc20a",
      storageBucket: "fusioncya-cc20a.appspot.com",
      messagingSenderId: "765164293111",
      appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
      measurementId: "G-4DT52P7MPB"
    };
    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // === ADMIN MODERATION ===
    const ADMIN_UIDS = [
      "Cyabanz" // <-- Use your actual UID string, not username.
    ];

    // --- UI ELEMENTS ---
    const $ = s => document.querySelector(s);
    let GAMES = [];
    let game = null;
    let likesData = {likes:0,dislikes:0,userLiked:false,userDisliked:false};
    let userFavorites = [], userHistory = [];
    let currentUser = null;
    let commentsUnsubscribe = null;
    let lastCommentTime = 0;
    let commentCooldown = 30 * 1000; // 30s per comment per user
    let lastCommentText = "";
    let lastCommentTimestamp = 0;
    let gamePlayCount = 0;

    // --- BAD WORDS & SPAM ---
    const BAD_WORDS = [
      'fuck','shit','bitch','cunt','nigger','fag','asshole','bastard','slut','dick','pussy','whore','faggot','cock','retard','cum','rape'
    ];
    function containsBadWord(text) {
      const lower = text.toLowerCase();
      return BAD_WORDS.some(word => lower.includes(word));
    }
    function isSpam(text) {
      let now = Date.now();
      if (text.trim() === lastCommentText && now - lastCommentTimestamp < 60*1000) return true;
      if (now - lastCommentTime < commentCooldown) return true;
      return false;
    }

    function getGameId() {
      const url = new URL(window.location.href);
      return url.searchParams.get('id');
    }
    function userDocRef() {
      if (!currentUser) return null;
      return doc(db, 'users', currentUser.uid);
    }
    async function loadUserData() {
      if (!currentUser) return;
      const docRef = userDocRef();
      const docSnap = await getDoc(docRef);
      userFavorites = [];
      userHistory = [];
      if (docSnap.exists()) {
        const data = docSnap.data();
        userFavorites = data.favorites || [];
        userHistory = data.history || [];
      }
      renderActions();
    }
    async function toggleFavorite() {
      if (!currentUser) return;
      const idx = userFavorites.indexOf(game.id);
      if (idx >= 0) userFavorites.splice(idx, 1);
      else userFavorites.push(game.id);
      await setDoc(userDocRef(), { favorites: userFavorites }, { merge: true });
      renderActions();
    }
    async function addToHistory() {
      if (!currentUser) return;
      userHistory = userHistory.filter(h => h.id !== game.id);
      userHistory.unshift({ id: game.id, playedAt: Date.now() });
      userHistory = userHistory.slice(0, 20);
      await setDoc(userDocRef(), { history: userHistory }, { merge: true });
    }

    // ----- PLAYS -----
    async function incrementPlays() {
      if (!game) return;
      const ref = doc(db, 'gamePlays', game.id);
      await setDoc(ref, {}, { merge: true }); // ensure doc exists
      await updateDoc(ref, { count: increment(1) });
    }
    async function getPlays() {
      if (!game) return 0;
      const ref = doc(db, 'gamePlays', game.id);
      const d = await getDoc(ref);
      return d.exists() && typeof d.data().count === "number" ? d.data().count : 0;
    }
    async function updatePlaysDisplay() {
      gamePlayCount = await getPlays();
      $(".game-plays").innerHTML = `<i class='bx bx-user'></i> ${gamePlayCount.toLocaleString()} play${gamePlayCount===1?"":"s"}`;
    }

    // ----- Likes/Dislikes -----
    async function loadGameLikes() {
      let d = await getDoc(doc(db, 'gameLikes', game.id));
      likesData = {likes:0,dislikes:0,userLiked:false,userDisliked:false};
      if (d.exists()) {
        likesData.likes = d.data().likes || 0;
        likesData.dislikes = d.data().dislikes || 0;
        if (currentUser) {
          const liked = d.data().likedUsers || [];
          const disliked = d.data().dislikedUsers || [];
          likesData.userLiked = liked.includes(currentUser.uid);
          likesData.userDisliked = disliked.includes(currentUser.uid);
        }
      }
      renderActions();
    }
    async function updateGameLike(likeType) {
      if (!currentUser) return;
      const ref = doc(db, 'gameLikes', game.id);
      const d = await getDoc(ref);
      let likedUsers = [], dislikedUsers = [];
      let likes = 0, dislikes = 0;
      if (d.exists()) {
        likedUsers = d.data().likedUsers || [];
        dislikedUsers = d.data().dislikedUsers || [];
        likes = d.data().likes || 0;
        dislikes = d.data().dislikes || 0;
      }
      likedUsers = likedUsers.filter(u => u !== currentUser.uid);
      dislikedUsers = dislikedUsers.filter(u => u !== currentUser.uid);
      if (likeType === 'like') likedUsers.push(currentUser.uid);
      if (likeType === 'dislike') dislikedUsers.push(currentUser.uid);
      likes = likedUsers.length;
      dislikes = dislikedUsers.length;
      await setDoc(ref, { likes, dislikes, likedUsers, dislikedUsers }, { merge: true });
      await loadGameLikes();
    }

    function renderGame() {
      if (!game) {
        $('main').innerHTML = "<div style='color:#e53935;font-size:1.3em;margin:2em;'>Game not found.</div>";
        return;
      }
      document.title = game.title + ' | Play Game';
      $('.game-title').textContent = game.title;
      $('.game-thumb').src = game.thumb;
      $('.game-desc').textContent = game.description || '';
      $('.game-categories').innerHTML =
        (Array.isArray(game.categories) ? game.categories.map(c => `<span class="game-chip">${c}</span>`).join('') : `<span class="game-chip">${game.category}</span>`);
      $('.game-controls-info').style.display = 'none';
      $('.game-controls-info').textContent = game.controls ? game.controls : "No controls/instructions provided.";
      let iframe = $('.game-iframe');
      if(iframe) iframe.remove();
      iframe = document.createElement('iframe');
      iframe.className = 'game-iframe';
      iframe.setAttribute('allowfullscreen','true');
      iframe.src = game.url;
      $('.game-iframe-wrap').appendChild(iframe);
    }
    function renderActions() {
      $('.like-btn').classList.toggle('liked', likesData.userLiked);
      $('.dislike-btn').classList.toggle('disliked', likesData.userDisliked);
      $('.like-count').textContent = likesData.likes;
      $('.dislike-count').textContent = likesData.dislikes;
      $('.fav-btn').classList.toggle('favorited', userFavorites.includes(game.id));
    }

    function setListeners() {
      $('.play-btn').onclick = async () => {
        addToHistory();
        await incrementPlays();
        updatePlaysDisplay();
        const iframe = $('.game-iframe');
        if (iframe) iframe.contentWindow.focus();
      };
      $('.fav-btn').onclick = () => toggleFavorite();
      $('.like-btn').onclick = () => updateGameLike('like');
      $('.dislike-btn').onclick = () => updateGameLike('dislike');
      $('.fullscreen-btn').onclick = () => {
        window.open(game.url, '_blank').focus();
      };
      $('.game-controls-btn').onclick = () => {
        const info = $('.game-controls-info');
        if (info.style.display === 'none') info.style.display = '';
        else info.style.display = 'none';
      };
      $('.back-btn').onclick = () => window.location.href = 'games.html';
    }

    function showAuthBtn() {
      $('.auth-btn').style.display = '';
      $('.user-photo').style.display = 'none';
      $('.user-name').style.display = 'none';
      $('.logout-btn').style.display = 'none';
      $('.comment-form').style.display = 'none';
      $('.comment-form-info').style.display = '';
    }
    function showUser(user) {
      $('.auth-btn').style.display = 'none';
      $('.user-photo').src = user.photoURL;
      $('.user-photo').style.display = '';
      $('.user-name').textContent = user.displayName;
      $('.user-name').style.display = '';
      $('.logout-btn').style.display = '';
      $('.comment-form').style.display = '';
      $('.comment-form-info').style.display = 'none';
    }
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        showUser(user);
        loadUserData();
        loadGameLikes();
        setupComments();
      } else {
        showAuthBtn();
        setupComments();
      }
    });
    $('.auth-btn').onclick = () => {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider).catch(err => alert(err.message));
    };
    $('.logout-btn').onclick = () => signOut(auth);

    // ----- Comments -----
    function setupComments() {
      if (commentsUnsubscribe) commentsUnsubscribe();
      renderCommentsList([]);
      if (!game) return;
      const q = query(collection(db, 'games', game.id, 'comments'), orderBy('createdAt', 'desc'));
      commentsUnsubscribe = onSnapshot(q, snap => {
        let comments = [];
        snap.forEach(doc => {
          comments.push({ id: doc.id, ...doc.data() });
        });
        renderCommentsList(comments);
      });
    }
    async function postComment(text) {
      if (!currentUser) return;
      if (!game) return;
      if (containsBadWord(text)) throw new Error("Inappropriate language detected.");
      if (isSpam(text)) throw new Error("Please wait before posting again or avoid duplicate comments.");
      await addDoc(collection(db, 'games', game.id, 'comments'), {
        text,
        user: {
          uid: currentUser.uid,
          name: currentUser.displayName,
          photo: currentUser.photoURL || "",
        },
        createdAt: serverTimestamp(),
        likes: [],
        deleted: false
      });
      lastCommentText = text.trim();
      lastCommentTimestamp = Date.now();
      lastCommentTime = Date.now();
    }
    function renderCommentsList(comments) {
      const list = $('.comments-list');
      list.innerHTML = '';
      if (!comments.length) {
        list.innerHTML = `<div style="color:#888b9a;padding:1.4em;text-align:center;">No comments yet. Be the first to comment!</div>`;
        return;
      }
      comments.forEach(comment => {
        if(comment.deleted) {
          const div = document.createElement('div');
          div.className = 'comment-deleted';
          div.textContent = 'This comment was removed by a moderator.';
          list.appendChild(div);
          return;
        }
        const div = document.createElement('div');
        div.className = 'comment';
        const likedByMe = comment.likes && currentUser ? comment.likes.includes(currentUser.uid) : false;
        div.innerHTML = `
          <img class="comment-avatar" src="${comment.user.photo || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(comment.user.name)}" alt="">
          <div class="comment-main">
            <span class="comment-user">${comment.user.name || 'Unknown'}</span>
            <span class="comment-date">${comment.createdAt && comment.createdAt.toDate ? comment.createdAt.toDate().toLocaleString() : ''}</span>
            <div class="comment-text">${escapeHTML(comment.text)}</div>
            <div class="comment-actions">
              <button class="comment-like-btn${likedByMe ? ' liked' : ''}" title="Like"><i class='bx bxs-like'></i></button>
              <span class="comment-likes-count">${comment.likes ? comment.likes.length : 0}</span>
              ${isAdmin() ? `<button class="comment-admin-delete-btn" title="Delete" data-id="${comment.id}"><i class='bx bx-trash'></i> Delete</button>` : ""}
            </div>
          </div>
        `;
        div.querySelector('.comment-like-btn').onclick = () => handleLikeComment(comment.id, likedByMe, comment.likes || []);
        if(isAdmin()) {
          div.querySelector('.comment-admin-delete-btn').onclick = () => handleAdminDelete(comment.id);
        }
        list.appendChild(div);
      });
    }
    async function handleLikeComment(commentId, likedByMe, likesArr) {
      if (!currentUser) return;
      const ref = doc(db, 'games', game.id, 'comments', commentId);
      let newLikes = Array.isArray(likesArr) ? [...likesArr] : [];
      if (likedByMe) {
        newLikes = newLikes.filter(uid => uid !== currentUser.uid);
      } else {
        newLikes.push(currentUser.uid);
      }
      await updateDoc(ref, { likes: newLikes });
    }
    async function handleAdminDelete(commentId) {
      if (!isAdmin()) return;
      if (!confirm("Delete this comment? This action cannot be undone.")) return;
      const ref = doc(db, 'games', game.id, 'comments', commentId);
      await updateDoc(ref, { deleted: true, text: "", likes: [] });
    }
    function isAdmin() {
      return currentUser && ADMIN_UIDS.includes(currentUser.uid);
    }
    function escapeHTML(str) {
      return str.replace(/[<>&"'`]/g, c => ({
        '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;','`':'&#96;'
      })[c]);
    }

    window.addEventListener('DOMContentLoaded', async () => {
      showAuthBtn();
      const resp = await fetch('game.json');
      GAMES = await resp.json();
      const gameId = getGameId();
      game = GAMES.find(g => g.id === gameId);
      renderGame();
      setListeners();
      await updatePlaysDisplay();
      if (auth.currentUser) {
        loadUserData();
        loadGameLikes();
        setupComments();
      } else {
        setupComments();
      }
      $('.comment-input').oninput = () => {
        $('.comment-post-btn').disabled = !$('.comment-input').value.trim();
        $('.comment-error').textContent = '';
      };
      $('.comment-form').onsubmit = async e => {
        e.preventDefault();
        const text = $('.comment-input').value.trim();
        if (!text) return;
        if (containsBadWord(text)) {
          $('.comment-error').textContent = "Please avoid inappropriate language.";
          return;
        }
        if (isSpam(text)) {
          $('.comment-error').textContent = "Please wait before posting again or avoid duplicate comments.";
          return;
        }
        $('.comment-post-btn').disabled = true;
        try {
          await postComment(text);
          $('.comment-input').value = '';
          $('.comment-error').textContent = '';
        } catch (err) {
          $('.comment-error').textContent = err.message || "Failed to post comment.";
        }
        $('.comment-post-btn').disabled = false;
      };
      // Also increment plays on page load
      await incrementPlays();
      await updatePlaysDisplay();
    });
  </script>
</head>
<body>
  <button class="back-btn"><i class='bx bx-arrow-back'></i> Back to games</button>
  <div class="game-header">
    <img class="game-thumb" src="" alt="Game">
    <div class="game-meta-col">
      <div class="game-title"></div>
      <div class="game-categories"></div>
      <div class="game-plays"><i class='bx bx-user'></i> 0 plays</div>
      <div class="likes-row">
        <button class="icon-btn like-btn" title="Like"><i class='bx bxs-like'></i></button>
        <span class="like-count">0</span>
        <button class="icon-btn dislike-btn" title="Dislike"><i class='bx bxs-dislike'></i></button>
        <span class="dislike-count">0</span>
        <button class="action-btn fav-btn" title="Favorite"><i class='bx bxs-star'></i> Favorite</button>
        <button class="action-btn fullscreen-btn" title="Fullscreen"><i class='bx bx-fullscreen'></i> Fullscreen</button>
        <button class="game-controls-btn" title="Controls"><i class='bx bx-info-circle'></i> Controls</button>
      </div>
      <div class="game-controls-info" style="display:none;"></div>
    </div>
  </div>
  <div class="game-desc"></div>
  <div class="game-iframe-wrap"></div>
  <div class="game-actions">
    <button class="action-btn play-btn"><i class='bx bx-play'></i> Play</button>
    <button class="action-btn auth-btn" style="display:none;"><i class='bx bxl-google'></i> Sign in with Google</button>
    <img class="user-photo" style="display:none;">
    <span class="user-name" style="display:none;"></span>
    <button class="logout-btn" style="display:none;">Logout</button>
  </div>
  <main>
    <div class="comment-section">
      <div class="comment-title">Comments</div>
      <form class="comment-form" style="display:none;">
        <textarea class="comment-input" placeholder="Write a comment..." maxlength="500"></textarea>
        <button class="comment-post-btn" type="submit" disabled>Post</button>
        <div class="comment-error"></div>
      </form>
      <div class="comment-form-info" style="display:none;">Sign in to post a comment.</div>
      <div class="comments-list"></div>
    </div>
  </main>
</body>
</html>
