<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Play Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <style>
    /* ... (keep all previous CSS from earlier answer) ... */
    /* Add admin delete styling */
    .comment-admin-delete-btn {
      background: none;
      border: none;
      color: #e53935;
      font-size: 1.1em;
      cursor: pointer;
      margin-left: 0.7em;
    }
    .comment-admin-delete-btn:hover {
      text-decoration: underline;
      color: #ff1744;
    }
    .comment-deleted {
      color: #b0b7c3;
      font-style: italic;
      font-size: 1em;
      margin: 0.8em 0;
      padding-left: 5.3em;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, updateDoc, arrayUnion, arrayRemove, serverTimestamp, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
      authDomain: "fusioncya-cc20a.firebaseapp.com",
      databaseURL: "https://fusioncya-cc20a-default-rtdb.firebaseio.com",
      projectId: "fusioncya-cc20a",
      storageBucket: "fusioncya-cc20a.appspot.com",
      messagingSenderId: "765164293111",
      appId: "1:765164293111:web:43e051c755c4690c0c3cf2",
      measurementId: "G-4DT52P7MPB"
    };
    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // === ADMIN MODERATION ===
    // List of admin UIDs, add more if needed!
    // You can get your UID from the Firebase Auth Users section.
    const ADMIN_UIDS = [
      // Example: "abc123youruid"
      // Replace with your UID. For example:
      "Cyabanz" // <-- Use your actual UID string, not username.
    ];

    // --- UI ELEMENTS ---
    const $ = s => document.querySelector(s);
    let GAMES = [];
    let game = null;
    let likesData = {likes:0,dislikes:0,userLiked:false,userDisliked:false};
    let userFavorites = [], userHistory = [];
    let currentUser = null;
    let commentsUnsubscribe = null;
    let lastCommentTime = 0;
    let commentCooldown = 30 * 1000; // 30s per comment per user
    let lastCommentText = "";
    let lastCommentTimestamp = 0;

    // Bad word filter (client-side, simple, customizable)
    const BAD_WORDS = [
      'fuck','shit','bitch','cunt','nigger','fag','asshole','bastard','slut','dick','pussy','whore','faggot','cock','retard','cum','rape'
    ];
    function containsBadWord(text) {
      const lower = text.toLowerCase();
      return BAD_WORDS.some(word => lower.includes(word));
    }
    function isSpam(text) {
      // Block if comment is repeated or too frequent
      let now = Date.now();
      // Block if the same as last comment
      if (text.trim() === lastCommentText && now - lastCommentTimestamp < 60*1000) return true;
      // Block if too fast
      if (now - lastCommentTime < commentCooldown) return true;
      return false;
    }

    // Get ID from URL
    function getGameId() {
      const url = new URL(window.location.href);
      return url.searchParams.get('id');
    }

    // ----- Firebase User Data -----
    function userDocRef() {
      if (!currentUser) return null;
      return doc(db, 'users', currentUser.uid);
    }
    async function loadUserData() {
      if (!currentUser) return;
      const docRef = userDocRef();
      const docSnap = await getDoc(docRef);
      userFavorites = [];
      userHistory = [];
      if (docSnap.exists()) {
        const data = docSnap.data();
        userFavorites = data.favorites || [];
        userHistory = data.history || [];
      }
      renderActions();
    }
    async function toggleFavorite() {
      if (!currentUser) return;
      const idx = userFavorites.indexOf(game.id);
      if (idx >= 0) userFavorites.splice(idx, 1);
      else userFavorites.push(game.id);
      await setDoc(userDocRef(), { favorites: userFavorites }, { merge: true });
      renderActions();
    }
    async function addToHistory() {
      if (!currentUser) return;
      userHistory = userHistory.filter(h => h.id !== game.id);
      userHistory.unshift({ id: game.id, playedAt: Date.now() });
      userHistory = userHistory.slice(0, 20);
      await setDoc(userDocRef(), { history: userHistory }, { merge: true });
    }

    // ----- Likes/Dislikes -----
    async function loadGameLikes() {
      let d = await getDoc(doc(db, 'gameLikes', game.id));
      likesData = {likes:0,dislikes:0,userLiked:false,userDisliked:false};
      if (d.exists()) {
        likesData.likes = d.data().likes || 0;
        likesData.dislikes = d.data().dislikes || 0;
        if (currentUser) {
          const liked = d.data().likedUsers || [];
          const disliked = d.data().dislikedUsers || [];
          likesData.userLiked = liked.includes(currentUser.uid);
          likesData.userDisliked = disliked.includes(currentUser.uid);
        }
      }
      renderActions();
    }
    async function updateGameLike(likeType) {
      if (!currentUser) return;
      const ref = doc(db, 'gameLikes', game.id);
      const d = await getDoc(ref);
      let likedUsers = [], dislikedUsers = [];
      let likes = 0, dislikes = 0;
      if (d.exists()) {
        likedUsers = d.data().likedUsers || [];
        dislikedUsers = d.data().dislikedUsers || [];
        likes = d.data().likes || 0;
        dislikes = d.data().dislikes || 0;
      }
      likedUsers = likedUsers.filter(u => u !== currentUser.uid);
      dislikedUsers = dislikedUsers.filter(u => u !== currentUser.uid);
      if (likeType === 'like') likedUsers.push(currentUser.uid);
      if (likeType === 'dislike') dislikedUsers.push(currentUser.uid);
      likes = likedUsers.length;
      dislikes = dislikedUsers.length;
      await setDoc(ref, { likes, dislikes, likedUsers, dislikedUsers }, { merge: true });
      await loadGameLikes();
    }

    // ----- Render -----
    function renderGame() {
      if (!game) {
        $('main').innerHTML = "<div style='color:#e53935;font-size:1.3em;margin:2em;'>Game not found.</div>";
        return;
      }
      document.title = game.title + ' | Play Game';
      $('.game-title').textContent = game.title;
      $('.game-thumb').src = game.thumb;
      $('.game-desc').textContent = game.description || '';
      $('.game-categories').innerHTML =
        (Array.isArray(game.categories) ? game.categories.map(c => `<span class="game-chip">${c}</span>`).join('') : `<span class="game-chip">${game.category}</span>`);
      $('.game-controls-info').style.display = 'none';
      $('.game-controls-info').textContent = game.controls ? game.controls : "No controls/instructions provided.";
      let iframe = $('.game-iframe');
      if(iframe) iframe.remove();
      iframe = document.createElement('iframe');
      iframe.className = 'game-iframe';
      iframe.setAttribute('allowfullscreen','true');
      iframe.src = game.url;
      $('.game-iframe-wrap').appendChild(iframe);
    }
    function renderActions() {
      $('.like-btn').classList.toggle('liked', likesData.userLiked);
      $('.dislike-btn').classList.toggle('disliked', likesData.userDisliked);
      $('.like-count').textContent = likesData.likes;
      $('.dislike-count').textContent = likesData.dislikes;
      $('.fav-btn').classList.toggle('favorited', userFavorites.includes(game.id));
    }

    // ----- Listeners -----
    function setListeners() {
      $('.play-btn').onclick = () => {
        addToHistory();
        const iframe = $('.game-iframe');
        if (iframe) iframe.contentWindow.focus();
      };
      $('.fav-btn').onclick = () => toggleFavorite();
      $('.like-btn').onclick = () => updateGameLike('like');
      $('.dislike-btn').onclick = () => updateGameLike('dislike');
      $('.fullscreen-btn').onclick = () => {
        window.open(game.url, '_blank').focus();
      };
      $('.game-controls-btn').onclick = () => {
        const info = $('.game-controls-info');
        if (info.style.display === 'none') info.style.display = '';
        else info.style.display = 'none';
      };
      $('.back-btn').onclick = () => window.location.href = 'games.html';
    }

    // ----- Auth -----
    function showAuthBtn() {
      $('.auth-btn').style.display = '';
      $('.user-photo').style.display = 'none';
      $('.user-name').style.display = 'none';
      $('.logout-btn').style.display = 'none';
      $('.comment-form').style.display = 'none';
      $('.comment-form-info').style.display = '';
    }
    function showUser(user) {
      $('.auth-btn').style.display = 'none';
      $('.user-photo').src = user.photoURL;
      $('.user-photo').style.display = '';
      $('.user-name').textContent = user.displayName;
      $('.user-name').style.display = '';
      $('.logout-btn').style.display = '';
      $('.comment-form').style.display = '';
      $('.comment-form-info').style.display = 'none';
    }
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        showUser(user);
        loadUserData();
        loadGameLikes();
        setupComments();
      } else {
        showAuthBtn();
        setupComments();
      }
    });
    $('.auth-btn').onclick = () => {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider).catch(err => alert(err.message));
    };
    $('.logout-btn').onclick = () => signOut(auth);

    // ----- Comments -----
    function setupComments() {
      if (commentsUnsubscribe) commentsUnsubscribe();
      renderCommentsList([]);
      if (!game) return;
      const q = query(collection(db, 'games', game.id, 'comments'), orderBy('createdAt', 'desc'));
      commentsUnsubscribe = onSnapshot(q, snap => {
        let comments = [];
        snap.forEach(doc => {
          comments.push({ id: doc.id, ...doc.data() });
        });
        renderCommentsList(comments);
      });
    }
    async function postComment(text) {
      if (!currentUser) return;
      if (!game) return;
      if (containsBadWord(text)) throw new Error("Inappropriate language detected.");
      if (isSpam(text)) throw new Error("Please wait before posting again or avoid duplicate comments.");
      await addDoc(collection(db, 'games', game.id, 'comments'), {
        text,
        user: {
          uid: currentUser.uid,
          name: currentUser.displayName,
          photo: currentUser.photoURL || "",
        },
        createdAt: serverTimestamp(),
        likes: [],
        deleted: false
      });
      lastCommentText = text.trim();
      lastCommentTimestamp = Date.now();
      lastCommentTime = Date.now();
    }
    function renderCommentsList(comments) {
      const list = $('.comments-list');
      list.innerHTML = '';
      if (!comments.length) {
        list.innerHTML = `<div style="color:#888b9a;padding:1.4em;text-align:center;">No comments yet. Be the first to comment!</div>`;
        return;
      }
      comments.forEach(comment => {
        // If deleted, show deleted message for everyone
        if(comment.deleted) {
          const div = document.createElement('div');
          div.className = 'comment-deleted';
          div.textContent = 'This comment was removed by a moderator.';
          list.appendChild(div);
          return;
        }
        const div = document.createElement('div');
        div.className = 'comment';
        const likedByMe = comment.likes && currentUser ? comment.likes.includes(currentUser.uid) : false;
        div.innerHTML = `
          <img class="comment-avatar" src="${comment.user.photo || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(comment.user.name)}" alt="">
          <div class="comment-main">
            <span class="comment-user">${comment.user.name || 'Unknown'}</span>
            <span class="comment-date">${comment.createdAt && comment.createdAt.toDate ? comment.createdAt.toDate().toLocaleString() : ''}</span>
            <div class="comment-text">${escapeHTML(comment.text)}</div>
            <div class="comment-actions">
              <button class="comment-like-btn${likedByMe ? ' liked' : ''}" title="Like"><i class='bx bxs-like'></i></button>
              <span class="comment-likes-count">${comment.likes ? comment.likes.length : 0}</span>
              ${isAdmin() ? `<button class="comment-admin-delete-btn" title="Delete" data-id="${comment.id}"><i class='bx bx-trash'></i> Delete</button>` : ""}
            </div>
          </div>
        `;
        div.querySelector('.comment-like-btn').onclick = () => handleLikeComment(comment.id, likedByMe, comment.likes || []);
        // Admin delete
        if(isAdmin()) {
          div.querySelector('.comment-admin-delete-btn').onclick = () => handleAdminDelete(comment.id);
        }
        list.appendChild(div);
      });
    }
    async function handleLikeComment(commentId, likedByMe, likesArr) {
      if (!currentUser) return;
      const ref = doc(db, 'games', game.id, 'comments', commentId);
      let newLikes = Array.isArray(likesArr) ? [...likesArr] : [];
      if (likedByMe) {
        newLikes = newLikes.filter(uid => uid !== currentUser.uid);
      } else {
        newLikes.push(currentUser.uid);
      }
      await updateDoc(ref, { likes: newLikes });
    }
    async function handleAdminDelete(commentId) {
      if (!isAdmin()) return;
      if (!confirm("Delete this comment? This action cannot be undone.")) return;
      const ref = doc(db, 'games', game.id, 'comments', commentId);
      // Instead of deleting, mark as deleted for audit trail.
      await updateDoc(ref, { deleted: true, text: "", likes: [] });
    }
    function isAdmin() {
      // Use UID, not displayName. Use Firebase console to get your UID!
      return currentUser && ADMIN_UIDS.includes(currentUser.uid);
    }
    function escapeHTML(str) {
      return str.replace(/[<>&"'`]/g, c => ({
        '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;','`':'&#96;'
      })[c]);
    }

    // ----- Comment Form -----
    window.addEventListener('DOMContentLoaded', async () => {
      showAuthBtn();
      const resp = await fetch('game.json');
      GAMES = await resp.json();
      const gameId = getGameId();
      game = GAMES.find(g => g.id === gameId);
      renderGame();
      setListeners();
      if (auth.currentUser) {
        loadUserData();
        loadGameLikes();
        setupComments();
      } else {
        setupComments();
      }
      $('.comment-input').oninput = () => {
        $('.comment-post-btn').disabled = !$('.comment-input').value.trim();
        $('.comment-error').textContent = '';
      };
      $('.comment-form').onsubmit = async e => {
        e.preventDefault();
        const text = $('.comment-input').value.trim();
        if (!text) return;
        if (containsBadWord(text)) {
          $('.comment-error').textContent = "Please avoid inappropriate language.";
          return;
        }
        if (isSpam(text)) {
          $('.comment-error').textContent = "Please wait before posting again or avoid duplicate comments.";
          return;
        }
        $('.comment-post-btn').disabled = true;
        try {
          await postComment(text);
          $('.comment-input').value = '';
          $('.comment-error').textContent = '';
        } catch (err) {
          $('.comment-error').textContent = err.message || "Failed to post comment.";
        }
        $('.comment-post-btn').disabled = false;
      };
    });
  </script>
</head>
<body>
  <button class="back-btn"><i class='bx bx-arrow-back'></i> Back to games</button>
  <div class="game-header">
    <img class="game-thumb" src="" alt="Game">
    <div>
      <div class="game-title"></div>
      <div class="game-categories"></div>
      <div class="likes-row">
        <button class="icon-btn like-btn" title="Like"><i class='bx bxs-like'></i></button>
        <span class="like-count">0</span>
        <button class="icon-btn dislike-btn" title="Dislike"><i class='bx bxs-dislike'></i></button>
        <span class="dislike-count">0</span>
        <button class="action-btn fav-btn" title="Favorite"><i class='bx bxs-star'></i> Favorite</button>
        <button class="action-btn fullscreen-btn" title="Fullscreen"><i class='bx bx-fullscreen'></i> Fullscreen</button>
        <button class="game-controls-btn" title="Controls"><i class='bx bx-info-circle'></i> Controls</button>
      </div>
      <div class="game-controls-info" style="display:none;"></div>
    </div>
  </div>
  <div class="game-desc"></div>
  <div class="game-iframe-wrap"></div>
  <div class="game-actions">
    <button class="action-btn play-btn"><i class='bx bx-play'></i> Play</button>
    <button class="action-btn auth-btn" style="display:none;"><i class='bx bxl-google'></i> Sign in with Google</button>
    <img class="user-photo" style="display:none;width:32px;height:32px;border-radius:50%;vertical-align:middle;">
    <span class="user-name" style="display:none;margin-left:0.6em;"></span>
    <button class="logout-btn" style="display:none;">Logout</button>
  </div>
  <main>
    <div class="comment-section">
      <div class="comment-title">Comments</div>
      <form class="comment-form" style="display:none;">
        <textarea class="comment-input" placeholder="Write a comment..." maxlength="500"></textarea>
        <button class="comment-post-btn" type="submit" disabled>Post</button>
        <div class="comment-error"></div>
      </form>
      <div class="comment-form-info" style="color:#b0b7c3;display:none;">Sign in to post a comment.</div>
      <div class="comments-list"></div>
    </div>
  </main>
</body>
</html>
