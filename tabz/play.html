<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Play Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #181c24; color: #e8eaf0; margin: 0; }
    .comment-stars-selector .star {
      font-size: 2em;
      color: #ffd600;
      opacity: 0.5;
      cursor: pointer;
      transition: opacity 0.1s;
      user-select: none;
    }
    .comment-stars-selector .star.selected,
    .comment-stars-selector .star.filled {
      opacity: 1;
    }
    .comments-list .star {
      color: #ffd600;
      font-size: 1.2em;
      margin-right: 0.07em;
    }
  </style>
</head>
<body>
  <main>
    <section>
      <form class="comment-form">
        <div class="comment-stars-selector">
          <span class="comment-stars"></span>
        </div>
        <textarea class="comment-input" placeholder="Write a comment..." maxlength="500"></textarea>
        <button class="comment-post-btn" type="submit" disabled>Post</button>
        <div class="comment-error" style="color:red"></div>
        <div style="color:#90caf9;font-size:0.9em;">Star value: <span id="star-value-preview">0</span></div>
      </form>
      <div class="comments-list"></div>
    </section>
  </main>
  <script type="module">
    // --- Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    // Your config (replace with your real keys)
    const firebaseConfig = {
      apiKey: "AIzaSyADCVIINCBgvTBvClWqWI5o3SlVS47IJnw",
      authDomain: "fusioncya-cc20a.firebaseapp.com",
      projectId: "fusioncya-cc20a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Bulletproof Star Picker ---
    let commentStarRating = 0;
    function renderCommentStarsSelector(hover=0) {
      const starsWrap = document.querySelector('.comment-stars');
      starsWrap.innerHTML = '';
      let fill = hover || commentStarRating;
      for (let i=1; i<=5; i++) {
        const s = document.createElement('span');
        s.className = 'star' + (i <= fill ? ' filled' : '');
        if (i === commentStarRating) s.classList.add('selected');
        s.textContent = '★';
        s.addEventListener('mouseenter', () => renderCommentStarsSelector(i));
        s.addEventListener('mouseleave', () => renderCommentStarsSelector(0));
        s.addEventListener('click', () => {
          commentStarRating = i;
          document.getElementById('star-value-preview').textContent = commentStarRating;
          renderCommentStarsSelector();
        });
        starsWrap.appendChild(s);
      }
      document.getElementById('star-value-preview').textContent = commentStarRating;
    }

    renderCommentStarsSelector();

    // --- Enable/disable post button based on textarea ---
    document.querySelector('.comment-input').addEventListener('input', (e) => {
      document.querySelector('.comment-post-btn').disabled = !e.target.value.trim();
      document.querySelector('.comment-error').textContent = "";
    });

    // --- Comments in Firestore (demo: all comments are in "demo_comments" collection) ---
    const COMMENTS_COLLECTION = "demo_comments";

    // --- Render comments ---
    function renderCommentsList(comments) {
      const list = document.querySelector('.comments-list');
      list.innerHTML = '';
      if (comments.length === 0) {
        list.innerHTML = '<div style="color:#888b9a;text-align:center;padding:2em;">No comments yet.</div>';
        return;
      }
      for (const comment of comments) {
        const div = document.createElement('div');
        let stars = "";
        for (let i=1; i<=5; i++) {
          stars += `<span class="star"${i <= (comment.stars || 0) ? ' style="opacity:1"' : ' style="opacity:0.3"'}>★</span>`;
        }
        div.innerHTML = `<div>${stars} <b>${comment.text}</b></div>`;
        list.appendChild(div);
      }
    }

    // --- Live Firestore comments listener ---
    const q = query(collection(db, COMMENTS_COLLECTION), orderBy("createdAt", "desc"));
    onSnapshot(q, snap => {
      const comments = [];
      snap.forEach(doc => comments.push(doc.data()));
      renderCommentsList(comments);
    });

    // --- Submit handler ---
    document.querySelector('.comment-form').onsubmit = async e => {
      e.preventDefault();
      const text = document.querySelector('.comment-input').value.trim();
      if (!text) return;
      if (commentStarRating === 0) {
        document.querySelector('.comment-error').textContent = "Select a star rating.";
        return;
      }
      try {
        await addDoc(collection(db, COMMENTS_COLLECTION), {
          text,
          stars: commentStarRating,
          createdAt: serverTimestamp()
        });
        commentStarRating = 0;
        document.querySelector('.comment-input').value = '';
        document.querySelector('.comment-post-btn').disabled = true;
        renderCommentStarsSelector();
        document.querySelector('.comment-error').textContent = '';
      } catch (e) {
        document.querySelector('.comment-error').textContent = "Failed to post comment: " + e.message;
      }
    };
  </script>
</body>
</html>
